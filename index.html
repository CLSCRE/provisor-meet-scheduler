<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ProVisors LA Meeting Groups</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; background: #f5f6fa; color: #2d3436; }

    /* Header */
    .header {
      background: linear-gradient(135deg, #153D63 0%, #1a5276 100%);
      color: white; padding: 16px 32px; display: flex; align-items: center; justify-content: space-between;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    .header h1 { font-size: 24px; font-weight: 700; }
    .header h1 span { color: #C5A355; }
    .header .subtitle { font-size: 13px; opacity: 0.8; margin-top: 2px; }
    .stats-bar { display: flex; gap: 24px; }
    .stat { text-align: center; }
    .stat .num { font-size: 22px; font-weight: 700; color: #C5A355; }
    .stat .label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.8; }

    /* Layout */
    .container { display: flex; height: calc(100vh - 100px); }
    .sidebar { width: 520px; min-width: 520px; display: flex; flex-direction: column; background: white; border-right: 1px solid #dfe6e9; }
    .right-panel { flex: 1; position: relative; display: flex; flex-direction: column; }

    /* View Tabs */
    .view-tabs {
      display: flex; background: #f0f2f5; border-bottom: 1px solid #dfe6e9; flex-shrink: 0;
    }
    .view-tab {
      flex: 1; padding: 10px 16px; text-align: center; font-size: 13px; font-weight: 600;
      cursor: pointer; border: none; background: transparent; color: #636e72;
      border-bottom: 3px solid transparent; transition: all 0.2s;
    }
    .view-tab:hover { color: #153D63; background: #e8ecf0; }
    .view-tab.active { color: #153D63; border-bottom-color: #C5A355; background: white; }
    .view-content { flex: 1; position: relative; overflow: hidden; }
    .view-pane { position: absolute; inset: 0; transition: opacity 0.2s; }
    .view-pane.hidden { opacity: 0; pointer-events: none; z-index: 0; }
    .view-pane.visible { opacity: 1; pointer-events: auto; z-index: 1; }

    /* Controls */
    .controls { padding: 12px 16px; border-bottom: 1px solid #eee; background: #fafafa; }
    .address-row { display: flex; gap: 8px; margin-bottom: 8px; }
    .address-row input {
      flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;
      outline: none; transition: border-color 0.2s;
    }
    .address-row input:focus { border-color: #153D63; }
    .address-row button {
      padding: 8px 14px; background: #153D63; color: white; border: none; border-radius: 6px;
      font-size: 13px; cursor: pointer; white-space: nowrap; font-weight: 600; transition: background 0.2s;
    }
    .address-row button:hover { background: #1a5276; }
    .address-row button.secondary { background: #C5A355; }
    .address-row button.secondary:hover { background: #b8963e; }
    .filter-row { display: flex; gap: 6px; flex-wrap: wrap; }
    .filter-row select, .filter-row input {
      padding: 6px 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 12px; background: white; outline: none;
    }
    .filter-row input { flex: 1; min-width: 100px; }
    .filter-row select { min-width: 90px; }

    /* Table */
    .table-wrap { flex: 1; overflow-y: auto; }
    .table-wrap table { width: 100%; border-collapse: collapse; font-size: 12px; }
    .table-wrap thead { position: sticky; top: 0; z-index: 2; }
    .table-wrap th {
      background: #153D63; color: white; padding: 7px 8px; text-align: left;
      font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.3px;
      cursor: pointer; user-select: none; white-space: nowrap;
    }
    .table-wrap th:hover { background: #1a5276; }
    .table-wrap td { padding: 6px 8px; border-bottom: 1px solid #f0f0f0; }
    .table-wrap tr:hover { background: #f8f9ff; cursor: pointer; }
    .table-wrap tr.selected { background: #e8f0fe; }
    .badge { display: inline-block; padding: 2px 7px; border-radius: 10px; font-size: 10px; font-weight: 600; text-transform: uppercase; }
    .badge.home { background: #dfe6fd; color: #2952cc; }
    .badge.affinity { background: #fde8d0; color: #b35c00; }
    .badge.virtual { background: #e8f4fd; color: #0077b6; font-size: 9px; padding: 1px 5px; }
    .badge.in-person { background: #e8f7ed; color: #1a7f37; font-size: 9px; padding: 1px 5px; }
    .badge.hybrid { background: #f3e8fd; color: #7b2cbf; font-size: 9px; padding: 1px 5px; }
    .distance-cell { font-weight: 600; color: #153D63; white-space: nowrap; }
    .table-wrap th.cb-col, .table-wrap td.cb-col { width: 28px; text-align: center; padding: 6px 2px; }
    .table-wrap td.cb-col { cursor: default; }
    .cb-col input[type="checkbox"] { width: 14px; height: 14px; cursor: pointer; accent-color: #C5A355; }
    .table-footer { padding: 6px 16px; background: #fafafa; border-top: 1px solid #eee; font-size: 12px; color: #636e72; }

    /* My Meetings Panel */
    .my-meetings { border-top: 2px solid #C5A355; background: #fdfaf3; overflow: hidden; transition: max-height 0.3s ease; }
    .my-meetings.collapsed { max-height: 38px; }
    .my-meetings.expanded { max-height: 45vh; }
    .my-meetings-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 8px 16px; cursor: pointer; user-select: none;
    }
    .my-meetings-header h3 { font-size: 13px; font-weight: 700; color: #153D63; display: flex; align-items: center; gap: 8px; }
    .my-meetings-header .count-badge {
      background: #C5A355; color: white; font-size: 11px; font-weight: 700;
      padding: 1px 7px; border-radius: 10px; min-width: 20px; text-align: center;
    }
    .my-meetings-header .toggle-arrow { font-size: 12px; color: #636e72; transition: transform 0.3s; }
    .my-meetings.expanded .toggle-arrow { transform: rotate(180deg); }
    .my-meetings-actions { display: flex; gap: 6px; align-items: center; }
    .my-meetings-actions button {
      padding: 4px 10px; font-size: 11px; border-radius: 4px; cursor: pointer; font-weight: 600; border: none; transition: background 0.2s;
    }
    .btn-hub { background: #153D63; color: white; }
    .btn-hub:hover { background: #1a5276; }
    .btn-clear { background: #e0e0e0; color: #333; }
    .btn-clear:hover { background: #ccc; }
    .my-meetings-body { padding: 0 16px 8px; overflow-y: auto; max-height: calc(45vh - 38px); }
    .my-meeting-item { display: flex; align-items: center; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #f0e8d0; font-size: 12px; }
    .my-meeting-item:last-child { border-bottom: none; }
    .my-meeting-info { flex: 1; }
    .my-meeting-info strong { color: #153D63; }
    .my-meeting-info .meta { color: #636e72; font-size: 11px; }
    .my-meeting-remove { background: none; border: none; color: #c0392b; cursor: pointer; font-size: 16px; padding: 2px 6px; border-radius: 4px; line-height: 1; }
    .my-meeting-remove:hover { background: #fde8e8; }
    .my-meetings-empty { color: #999; font-size: 12px; padding: 4px 0; font-style: italic; }

    /* Map */
    #map { width: 100%; height: 100%; }
    .home-marker { background: #153D63; border: 2px solid white; border-radius: 50%; box-shadow: 0 1px 4px rgba(0,0,0,0.3); }
    .affinity-marker { background: #C5A355; border: 2px solid white; border-radius: 50%; box-shadow: 0 1px 4px rgba(0,0,0,0.3); }
    .user-marker { background: #e74c3c; border: 2px solid white; border-radius: 50%; box-shadow: 0 2px 6px rgba(0,0,0,0.4); }
    .leaflet-popup-content { font-family: 'Segoe UI', system-ui, sans-serif; font-size: 13px; line-height: 1.5; }
    .leaflet-popup-content strong { color: #153D63; }
    .popup-distance { margin-top: 6px; padding-top: 6px; border-top: 1px solid #eee; color: #C5A355; font-weight: 600; }
    .map-legend {
      position: absolute; bottom: 20px; right: 20px; z-index: 1000;
      background: white; padding: 10px 14px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); font-size: 12px;
    }
    .legend-item { display: flex; align-items: center; gap: 8px; margin-bottom: 3px; }
    .legend-dot { width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }

    /* ── Calendar View ── */
    .calendar-container { height: 100%; display: flex; flex-direction: column; background: white; overflow: hidden; }
    .cal-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 20px; background: #fafafa; border-bottom: 1px solid #eee; flex-shrink: 0;
    }
    .cal-header h2 { font-size: 18px; font-weight: 700; color: #153D63; }
    .cal-nav { display: flex; gap: 8px; align-items: center; }
    .cal-nav button {
      padding: 6px 12px; background: #153D63; color: white; border: none; border-radius: 6px;
      font-size: 12px; font-weight: 600; cursor: pointer; transition: background 0.2s;
    }
    .cal-nav button:hover { background: #1a5276; }
    .cal-nav button.today-btn { background: #C5A355; }
    .cal-nav button.today-btn:hover { background: #b8963e; }
    .cal-legend {
      display: flex; gap: 14px; align-items: center; font-size: 11px; color: #636e72;
    }
    .cal-legend-item { display: flex; align-items: center; gap: 4px; }
    .cal-legend-dot { width: 10px; height: 10px; border-radius: 2px; }

    .cal-grid-wrap { flex: 1; overflow-y: auto; padding: 12px 16px; }
    .cal-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 4px; }
    .cal-weekday { text-align: center; font-size: 11px; font-weight: 700; color: #636e72; text-transform: uppercase; padding: 4px; }
    .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }

    .cal-day {
      min-height: 100px; border: 1px solid #e8ecf0; border-radius: 6px; padding: 4px;
      background: white; display: flex; flex-direction: column; transition: box-shadow 0.2s;
    }
    .cal-day:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .cal-day.outside { background: #f8f9fa; opacity: 0.5; }
    .cal-day.today { border-color: #C5A355; border-width: 2px; box-shadow: 0 0 0 1px #C5A35533; }
    .cal-day.weekend { background: #fafbfc; }
    .cal-day-num {
      font-size: 12px; font-weight: 700; color: #2d3436; padding: 2px 4px; margin-bottom: 2px;
    }
    .cal-day.today .cal-day-num { color: #C5A355; }
    .cal-day.outside .cal-day-num { color: #b2bec3; }

    .cal-slots { display: flex; flex-direction: column; gap: 1px; flex: 1; }
    .cal-time-section { border-radius: 4px; padding: 1px; }
    .cal-time-section.section-morning,
    .cal-time-section.section-midday,
    .cal-time-section.section-evening { background: #e2e5eb; }
    .cal-time-header { font-size: 7px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; padding: 1px 3px; color: #4a5060; border-bottom: 1px solid rgba(0,0,0,0.1); margin-bottom: 1px; }
    .cal-slot {
      border-radius: 3px; padding: 2px 4px; font-size: 9px; cursor: pointer;
      display: flex; align-items: center; gap: 3px; min-height: 18px; transition: all 0.15s;
    }
    .cal-slot .slot-label { font-weight: 600; width: 12px; flex-shrink: 0; text-transform: uppercase; }

    /* Slot states */
    .cal-slot.open { background: #f0f7f0; border: 1px dashed #b8dab8; color: #7fba7f; }
    .cal-slot.open:hover { background: #e0f0e0; border-color: #7fba7f; }
    .cal-slot.booked-home-group { background: #1a7f37; color: white; border: 1px solid #1a7f37; cursor: default; }
    .cal-slot.booked-home-group .slot-name { font-weight: 700; }
    .cal-slot.booked { background: #153D63; color: white; border: 1px solid #153D63; cursor: default; }
    .cal-slot.booked .slot-name { font-weight: 600; }
    .cal-slot.booked-affinity { background: #C5A355; color: white; border: 1px solid #C5A355; cursor: default; }
    .cal-slot.available { background: #fff8e6; border: 1px solid #f0d78c; color: #b38f00; }
    .cal-slot.available:hover { background: #fff0c0; }
    .cal-slot .slot-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .cal-slot .slot-count {
      background: rgba(255,255,255,0.3); border-radius: 8px; padding: 0 4px;
      font-size: 8px; font-weight: 700; flex-shrink: 0;
    }

    /* Slot tooltip */
    .slot-tooltip {
      display: none; position: fixed; z-index: 10000; background: white; color: #2d3436;
      padding: 10px 14px; border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.2);
      font-size: 12px; max-width: 280px; border-left: 4px solid #153D63;
    }
    .slot-tooltip.show { display: block; }
    .slot-tooltip h4 { color: #153D63; margin-bottom: 4px; font-size: 13px; }
    .slot-tooltip .tt-groups { margin-top: 6px; }
    .slot-tooltip .tt-group {
      padding: 3px 0; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between;
    }
    .slot-tooltip .tt-group:last-child { border-bottom: none; }
    .slot-tooltip .tt-city { color: #636e72; }

    /* Hub Integration Bar */
    .hub-bar {
      display: flex; align-items: center; gap: 10px; padding: 6px 16px;
      background: #0d2b45; border-bottom: 1px solid #1a4060; font-size: 12px;
    }
    .hub-status { display: flex; align-items: center; gap: 6px; color: #8ca8c4; }
    .hub-dot { width: 8px; height: 8px; border-radius: 50%; background: #636e72; flex-shrink: 0; }
    .hub-dot.connected { background: #27ae60; }
    .hub-dot.syncing { background: #f39c12; animation: pulse 1s infinite; }
    .hub-dot.error { background: #e74c3c; }
    @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }
    .hub-bar button {
      padding: 4px 12px; border: none; border-radius: 4px; font-size: 11px; font-weight: 600;
      cursor: pointer; transition: all 0.2s;
    }
    .hub-bar .btn-sync { background: #C5A355; color: white; }
    .hub-bar .btn-sync:hover { background: #b8963e; }
    .hub-bar .btn-sync:disabled { opacity: 0.5; cursor: not-allowed; }
    .hub-bar .btn-login { background: #27ae60; color: white; }
    .hub-bar .btn-login:hover { background: #219a52; }
    .hub-bar .hub-info { color: #6b9bc0; flex: 1; }
    .hub-bar .hub-mode { display: flex; align-items: center; gap: 6px; }
    .hub-bar .hub-mode label { color: #8ca8c4; font-size: 11px; cursor: pointer; }
    .hub-bar .hub-mode input[type="checkbox"] { accent-color: #C5A355; cursor: pointer; }
    .hub-reg-badge {
      display: inline-block; padding: 1px 5px; border-radius: 3px; font-size: 9px;
      font-weight: 700; background: #27ae60; color: white; margin-left: 4px; vertical-align: middle;
    }

    /* Hub registration highlight in table */
    .table-wrap tr.hub-registered { background: #edf7ed; }
    .table-wrap tr.hub-registered:hover { background: #e0f0e0; }

    /* Calendar hub-booked slot */
    .cal-slot.hub-booked {
      background: #27ae60; color: white; border: 1px solid #27ae60;
      cursor: default; position: relative;
    }
    .cal-slot.hub-booked::after {
      content: '✓'; position: absolute; right: 3px; top: 0; font-size: 8px; opacity: 0.7;
    }

    /* Server config */
    .server-config {
      display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%);
      background: white; padding: 24px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      z-index: 10001; min-width: 360px;
    }
    .server-config.show { display: block; }
    .server-config h3 { color: #153D63; margin-bottom: 12px; }
    .server-config input { width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; margin-bottom: 8px; }
    .server-config .cfg-btns { display: flex; gap: 8px; justify-content: flex-end; }
    .server-config button { padding: 6px 16px; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; }
    .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 10000; }
    .overlay.show { display: block; }

    /* Responsive */
    @media (max-width: 1024px) {
      .container { flex-direction: column; height: auto; }
      .sidebar { width: 100%; min-width: auto; max-height: 50vh; }
      .right-panel { height: 50vh; }
      .cal-day { min-height: 70px; }
      .hub-bar { flex-wrap: wrap; }
    }
  </style>
</head>
<body>

<div class="header">
  <div>
    <h1>Pro<span>Visors</span> LA Meeting Groups</h1>
    <div class="subtitle">Greater Los Angeles Area &bull; Home &amp; Affinity Groups</div>
  </div>
  <div class="stats-bar">
    <div class="stat"><div class="num" id="stat-total">136</div><div class="label">Total Groups</div></div>
    <div class="stat"><div class="num" id="stat-home">99</div><div class="label">Home</div></div>
    <div class="stat"><div class="num" id="stat-affinity">36</div><div class="label">Affinity</div></div>
    <div class="stat"><div class="num" id="stat-cities">28</div><div class="label">Cities</div></div>
    <div class="stat"><div class="num" id="stat-selected" style="color:#e74c3c">0</div><div class="label">Selected</div></div>
  </div>
</div>

<!-- Hub Integration Bar -->
<div class="hub-bar" id="hub-bar">
  <div class="hub-status">
    <div class="hub-dot" id="hub-dot"></div>
    <span id="hub-status-text">Hub: Not connected</span>
  </div>
  <button class="btn-login" id="hub-login-btn" onclick="hubLogin()">Connect to Hub</button>
  <button class="btn-sync" id="hub-sync-btn" onclick="hubSync()" disabled>Sync Registrations</button>
  <span class="hub-info" id="hub-info"></span>
  <div class="hub-mode">
    <input type="checkbox" id="auto-book-toggle" onchange="toggleAutoBook()" />
    <label for="auto-book-toggle">Auto-Book via Hub</label>
  </div>
  <button class="btn-sync" onclick="showServerConfig()" style="background:#636e72;font-size:10px;padding:3px 8px;">Server</button>
</div>

<!-- Server Config Modal -->
<div class="overlay" id="cfg-overlay" onclick="hideServerConfig()"></div>
<div class="server-config" id="server-config">
  <h3>Local Server Settings</h3>
  <p style="font-size:12px;color:#636e72;margin-bottom:8px;">The Hub bot runs on your local machine via the API server.</p>
  <input type="text" id="server-url" placeholder="http://localhost:3002" />
  <p style="font-size:11px;color:#999;margin-bottom:12px;">Start the server: <code>uvicorn server:app --reload --port 3002</code></p>
  <div class="cfg-btns">
    <button onclick="hideServerConfig()" style="background:#e0e0e0;color:#333;">Cancel</button>
    <button onclick="saveServerConfig()" style="background:#153D63;color:white;">Save</button>
  </div>
</div>

<div class="container">
  <div class="sidebar">
    <div class="controls">
      <div class="address-row">
        <input type="text" id="user-address" placeholder="Enter your address to see distances..." />
        <button onclick="geocodeAddress()">Calculate</button>
        <button class="secondary" onclick="useMyLocation()">GPS</button>
      </div>
      <div class="filter-row">
        <input type="text" id="search" placeholder="Search groups..." oninput="applyFilters()" />
        <select id="filter-region" onchange="applyFilters()">
          <option value="">All Regions</option>
          <option value="LA Core">LA Core</option>
          <option value="LA Westside">LA Westside</option>
          <option value="LA Valley">LA Valley</option>
        </select>
        <select id="filter-type" onchange="applyFilters()">
          <option value="">All Types</option>
          <option value="Home">Home</option>
          <option value="Affinity">Affinity</option>
        </select>
        <select id="filter-day" onchange="applyFilters()">
          <option value="">All Days</option>
          <option value="Monday">Monday</option>
          <option value="Tuesday">Tuesday</option>
          <option value="Wednesday">Wednesday</option>
          <option value="Thursday">Thursday</option>
          <option value="Friday">Friday</option>
        </select>
        <select id="filter-format" onchange="applyFilters()">
          <option value="">All Formats</option>
          <option value="In-Person">In-Person</option>
          <option value="Virtual">Virtual</option>
          <option value="In-Person & Virtual">Hybrid</option>
        </select>
        <select id="sort-by" onchange="applyFilters()">
          <option value="name">Sort: Name</option>
          <option value="distance">Sort: Distance</option>
          <option value="city">Sort: City</option>
          <option value="day">Sort: Day</option>
        </select>
      </div>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th class="cb-col" onclick="event.stopPropagation()"></th>
            <th onclick="sortBy('name')">Group</th>
            <th onclick="sortBy('type')">Type</th>
            <th onclick="sortBy('city')">City</th>
            <th onclick="sortBy('day')">Day</th>
            <th onclick="sortBy('time')">Time</th>
            <th onclick="sortBy('format')">Format</th>
            <th onclick="sortBy('distance')">Dist.</th>
          </tr>
        </thead>
        <tbody id="table-body"></tbody>
      </table>
    </div>
    <div class="table-footer" id="table-footer">Showing 136 groups</div>
    <div class="my-meetings collapsed" id="my-meetings-panel">
      <div class="my-meetings-header" onclick="toggleMyMeetings()">
        <h3>My Meetings <span class="count-badge" id="my-meetings-count">0</span></h3>
        <div class="my-meetings-actions">
          <button class="btn-hub" onclick="event.stopPropagation(); openHub()">Open Hub</button>
          <button class="btn-clear" onclick="event.stopPropagation(); clearAllSelections()">Clear</button>
          <span class="toggle-arrow">&#9660;</span>
        </div>
      </div>
      <div class="my-meetings-body" id="my-meetings-body">
        <div class="my-meetings-empty">Check meetings above to add them to your list</div>
      </div>
    </div>
  </div>

  <div class="right-panel">
    <div class="view-tabs">
      <button class="view-tab active" data-view="map" onclick="switchView('map')">Map</button>
      <button class="view-tab" data-view="calendar" onclick="switchView('calendar')">Calendar</button>
    </div>
    <div class="view-content">
      <!-- Map View -->
      <div class="view-pane visible" id="view-map">
        <div id="map"></div>
        <div class="map-legend">
          <div class="legend-item"><div class="legend-dot" style="background:#153D63"></div> Home Group</div>
          <div class="legend-item"><div class="legend-dot" style="background:#C5A355"></div> Affinity Group</div>
          <div class="legend-item"><div class="legend-dot" style="background:#e74c3c"></div> Your Location</div>
        </div>
      </div>
      <!-- Calendar View -->
      <div class="view-pane hidden" id="view-calendar">
        <div class="calendar-container">
          <div class="cal-header">
            <div class="cal-nav">
              <button onclick="calNav(-1)">&larr; Prev</button>
              <h2 id="cal-month-title">February 2026</h2>
              <button onclick="calNav(1)">Next &rarr;</button>
              <button class="today-btn" onclick="calToday()">Today</button>
            </div>
            <div class="cal-legend">
              <div class="cal-legend-item"><div class="cal-legend-dot" style="background:#27ae60"></div> Hub Registered</div>
              <div class="cal-legend-item"><div class="cal-legend-dot" style="background:#1a7f37"></div> My Home Group</div>
              <div class="cal-legend-item"><div class="cal-legend-dot" style="background:#153D63"></div> Visiting Home</div>
              <div class="cal-legend-item"><div class="cal-legend-dot" style="background:#C5A355"></div> Affinity Group</div>
              <div class="cal-legend-item"><div class="cal-legend-dot" style="background:#fff8e6;border:1px solid #f0d78c"></div> Available</div>
              <div class="cal-legend-item"><div class="cal-legend-dot" style="background:#f0f7f0;border:1px dashed #b8dab8"></div> Open Slot</div>
            </div>
          </div>
          <div class="cal-grid-wrap">
            <div class="cal-weekdays">
              <div class="cal-weekday">Sun</div><div class="cal-weekday">Mon</div><div class="cal-weekday">Tue</div>
              <div class="cal-weekday">Wed</div><div class="cal-weekday">Thu</div><div class="cal-weekday">Fri</div>
              <div class="cal-weekday">Sat</div>
            </div>
            <div class="cal-grid" id="cal-grid"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="slot-tooltip" id="slot-tooltip"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ── City Coordinates ──
const CITY_COORDS = {
  "Los Angeles":[34.0522,-118.2437],"Beverly Hills":[34.0736,-118.4004],"Burbank":[34.1808,-118.309],
  "Claremont":[34.0967,-117.7198],"Glendale":[34.1425,-118.2551],"Hollywood":[34.0928,-118.3287],
  "Pasadena":[34.1478,-118.1445],"San Gabriel":[34.0961,-118.1058],"Studio City":[34.1486,-118.3968],
  "North Hollywood":[34.187,-118.3813],"Santa Monica":[34.0195,-118.4912],"El Segundo":[33.9192,-118.4165],
  "Manhattan Beach":[33.8847,-118.4109],"Playa Vista":[33.9742,-118.4176],"Torrance":[33.8358,-118.3406],
  "Venice":[33.985,-118.4695],"Encino":[34.1592,-118.5014],"Sherman Oaks":[34.1508,-118.449],
  "Calabasas":[34.1367,-118.6387],"Woodland Hills":[34.1681,-118.6059],"Westlake Village":[34.1417,-118.8053],
  "Westlake":[34.1417,-118.8053],"Oxnard":[34.1975,-119.1771],"Camarillo":[34.2164,-119.0376],
  "Simi Valley":[34.2694,-118.7815],"Moorpark":[34.2856,-118.882],"Valencia":[34.4436,-118.6115],
  "Santa Barbara":[34.4208,-119.6982],"LAV/Zoom":[34.17,-118.44],"LAV":[34.17,-118.44],
  "Century City":[34.0565,-118.4173]
};

// Neighborhood-level overrides: map group names to more precise locations
// so groups with city "Los Angeles" aren't all piled on downtown
const NEIGHBORHOOD_COORDS = {
  // Century City groups
  "Century City 1":[34.0580,-118.4155],"Century City 2":[34.0570,-118.4165],"Century City 3":[34.0575,-118.4180],
  "Century City 4":[34.0560,-118.4170],"Century City 5":[34.0565,-118.4145],"Century City 6":[34.0555,-118.4160],
  "Century City 7":[34.0585,-118.4175],
  // Beverly Hills (that are listed under LA)
  "Beverly Hills 1":[34.0710,-118.3970],"Beverly Hills 5":[34.0750,-118.4030],
  // Downtown LA
  "Downtown LA-1":[34.0530,-118.2450],"Downtown LA-2":[34.0510,-118.2420],"Downtown LA-3":[34.0540,-118.2400],
  "Downtown LA-4":[34.0520,-118.2470],"Downtown LA-5":[34.0500,-118.2460],
  // Brentwood
  "Brentwood":[34.0594,-118.4728],
  // Westwood
  "Westwood":[34.0635,-118.4455],"Westwood Village":[34.0610,-118.4470],
  // West LA
  "West Los Angeles":[34.0380,-118.4320],"West Los Angeles 2":[34.0395,-118.4340],
  // Westside (general West LA area)
  "Westside":[34.0420,-118.4450],"Westside 2":[34.0440,-118.4430],"Westside 3":[34.0400,-118.4470],
  // Mid City
  "Mid City":[34.0480,-118.3500],
  // Rancho Park
  "Rancho Park":[34.0370,-118.4140],
  // Entertainment (near West Hollywood / Sunset area)
  "Entertainment 1":[34.0870,-118.3640],"Entertainment 2":[34.0890,-118.3620],
  // Westside affinity groups — spread across Century City / West LA
  "Capital Markets":[34.0555,-118.4190],"Branding, Licensing, and IP":[34.0545,-118.4200],
  "Family Business":[34.0575,-118.4195],"Growth Affinity Group":[34.0590,-118.4140],
  "Healthcare Advisors":[34.0550,-118.4150],"Innovation":[34.0540,-118.4180],
  "LA Lawyers and Legal Professionals":[34.0560,-118.4210],"Middle Market":[34.0535,-118.4160],
  "M&A Capital Formation":[34.0570,-118.4130],"Non-Profit":[34.0585,-118.4185],
  "Real Estate – Greater Los Angeles":[34.0545,-118.4170],"Tax Masters":[34.0555,-118.4200],
  "Transactions & Transitions":[34.0565,-118.4190],"Women's (Westside)":[34.0580,-118.4210],
  // Core affinity groups — spread near downtown/mid-city
  "Distributors & Manufacturers":[34.0530,-118.2500],
  "LA Estate and Succession Planning":[34.0550,-118.2520],
  "LGBT+ Allies":[34.0560,-118.3000],
  "Seniors and Special Needs":[34.0490,-118.3100],
  "Women's (Core)":[34.0510,-118.2800],
};

function jitter(coords, index, total) {
  const spread = 0.006, angle = (index / total) * 2 * Math.PI, r = spread * Math.sqrt(index / total);
  return [coords[0] + r * Math.cos(angle), coords[1] + r * Math.sin(angle)];
}

// ── Groups Data ──
const GROUPS = [
  {region:"LA Core",type:"Home",name:"Beverly Hills 1",leader:"Rob Strauss",day:"2nd Tuesday",city:"Los Angeles",time:"7:30am – 9:00am"},
  {region:"LA Core",type:"Home",name:"Beverly Hills 2",leader:"Kevin Farrell",day:"3rd Wednesday",city:"Beverly Hills",time:"7:30am – 9:00am"},
  {region:"LA Core",type:"Home",name:"Beverly Hills 3",leader:"Maureen Bernstein",day:"2nd Thursday",city:"Beverly Hills",time:"7:30am – 9:00am"},
  {region:"LA Core",type:"Home",name:"Beverly Hills 4",leader:"Ivy Rappaport",day:"2nd Wednesday",city:"Beverly Hills",time:"7:30am – 9:00am"},
  {region:"LA Core",type:"Home",name:"Beverly Hills 5",leader:"Dmitry Gorin",day:"1st Friday",city:"Los Angeles",time:"7:30am – 9:00am"},
  {region:"LA Core",type:"Home",name:"Burbank 1",leader:"Griffin Lee",day:"1st Wednesday",city:"Burbank",time:"7:30am – 9:00am"},
  {region:"LA Core",type:"Home",name:"Burbank 2",leader:"Andre Sarkissian",day:"4th Tuesday",city:"Burbank",time:"7:30am – 9:00am"},
  {region:"LA Core",type:"Home",name:"Claremont",leader:"Alex Polamero",day:"2nd Thursday",city:"Claremont",time:"7:30am – 9:00am"},
  {region:"LA Core",type:"Home",name:"Downtown LA-1",leader:"Sasha Elkins",day:"4th Tuesday",city:"Los Angeles",time:"7:30am – 9:00am"},
  {region:"LA Core",type:"Home",name:"Downtown LA-2",leader:"Jeffrey Bollinger",day:"1st Thursday",city:"Los Angeles",time:"7:30am – 9:00am"},
  {region:"LA Core",type:"Home",name:"Downtown LA-3",leader:"Bill Saleebey",day:"4th Wednesday",city:"Los Angeles",time:"7:30am – 9:00am"},
  {region:"LA Core",type:"Home",name:"Downtown LA-4",leader:"Gideon Grunfeld",day:"1st Tuesday",city:"Los Angeles",time:"7:30am – 9:00am"},
  {region:"LA Core",type:"Home",name:"Downtown LA-5",leader:"Patricia Kotze-Ramos",day:"2nd Tuesday",city:"Los Angeles",time:"7:30am – 9:00am"},
  {region:"LA Core",type:"Home",name:"Glendale 1",leader:"Adam Walker",day:"2nd Thursday",city:"Glendale",time:"7:30am – 9:00am"},
  {region:"LA Core",type:"Home",name:"Glendale 2",leader:"Robert Sniderman",day:"4th Wednesday",city:"Glendale",time:"7:30am – 9:00am"},
  {region:"LA Core",type:"Home",name:"Hollywood",leader:"Will Tiao",day:"3rd Tuesday",city:"Hollywood",time:"7:30am – 9:00am"},
  {region:"LA Core",type:"Home",name:"Mid City",leader:"Jay Goldberg",day:"2nd Friday",city:"Los Angeles",time:"7:30am – 9:00am"},
  {region:"LA Core",type:"Home",name:"Pasadena 1",leader:"Scott Clauson",day:"2nd Friday",city:"Pasadena",time:"7:30am – 9:00am"},
  {region:"LA Core",type:"Home",name:"Pasadena 2",leader:"David Painter",day:"3rd Tuesday",city:"Pasadena",time:"7:30am – 9:00am"},
  {region:"LA Core",type:"Home",name:"Pasadena 3",leader:"John Celic",day:"3rd Friday",city:"Pasadena",time:"7:30am – 9:00am"},
  {region:"LA Core",type:"Home",name:"Pasadena 4",leader:"Valerie Costanza",day:"2nd Tuesday",city:"Pasadena",time:"7:30am – 9:00am"},
  {region:"LA Core",type:"Home",name:"Pasadena 5",leader:"Preston Howard",day:"1st Tuesday",city:"Pasadena",time:"7:30am – 9:00am"},
  {region:"LA Core",type:"Home",name:"Pasadena 6",leader:"Ashley Andrews",day:"3rd Thursday",city:"Pasadena",time:"7:30am – 9:00am"},
  {region:"LA Core",type:"Home",name:"Pasadena 7",leader:"Emily Vincent",day:"3rd Wednesday",city:"San Gabriel",time:"7:00am – 9:00am"},
  {region:"LA Core",type:"Home",name:"Pasadena 8",leader:"Griselda Cervantes",day:"1st Thursday",city:"Pasadena",time:"11:30am – 1:00pm"},
  {region:"LA Core",type:"Home",name:"Rancho Park",leader:"Francis Ryu",day:"3rd Thursday",city:"Los Angeles",time:"7:30am – 9:00am"},
  {region:"LA Core",type:"Home",name:"Studio City",leader:"Anthony Behar",day:"2nd Wednesday",city:"Studio City",time:"7:00am – 9:00am"},
  {region:"LA Core",type:"Home",name:"Universal City",leader:"Scott Nell",day:"3rd Wednesday",city:"North Hollywood",time:"7:30am – 9:00am"},
  {region:"LA Core",type:"Home",name:"West Hollywood",leader:"Garry Gekht",day:"2nd Thursday",city:"Beverly Hills",time:"7:30am – 9:00am"},
  {region:"LA Core",type:"Affinity",name:"Distributors & Manufacturers",leader:"Keith Gregory",day:"3rd Wednesday",city:"Los Angeles",time:"1:45pm – 3:30pm"},
  {region:"LA Core",type:"Affinity",name:"East Valley Lawyer's",leader:"Cynthia Flynn",day:"4th Wednesday",city:"Glendale",time:"12:00pm – 1:30pm"},
  {region:"LA Core",type:"Affinity",name:"East Valley Women's",leader:"Janice Cohen",day:"4th Friday",city:"Pasadena",time:"11:30am – 1:30pm"},
  {region:"LA Core",type:"Affinity",name:"LA Estate and Succession Planning",leader:"Gregg Wind",day:"2nd Thursday",city:"Los Angeles",time:"12:00pm – 1:30pm"},
  {region:"LA Core",type:"Affinity",name:"LGBT+ Allies",leader:"Regina Lark",day:"4th Monday",city:"Los Angeles",time:"11:30am – 1:30pm"},
  {region:"LA Core",type:"Affinity",name:"Pasadena Estate & Succession Planning",leader:"Mary McDonald Winners",day:"3rd Wednesday",city:"Pasadena",time:"12:00pm – 1:30pm"},
  {region:"LA Core",type:"Affinity",name:"San Gabriel Valley Real Estate",leader:"David Barulich",day:"2nd Tuesday",city:"Pasadena",time:"12:00pm – 1:30pm"},
  {region:"LA Core",type:"Affinity",name:"Seniors and Special Needs",leader:"Marty Stevens-Heebner",day:"4th Tuesday",city:"Los Angeles",time:"11:30am – 1:30pm"},
  {region:"LA Core",type:"Affinity",name:"Women's (Core)",leader:"Jae Wu",day:"3rd Monday",city:"Los Angeles",time:"11:30am – 1:30pm"},
  {region:"LA Westside",type:"Home",name:"Brentwood",leader:"Nannina Angioni",day:"3rd Thursday",city:"Los Angeles",time:"7:00am – 9:00am"},
  {region:"LA Westside",type:"Home",name:"Century City 1",leader:"Grant Withers",day:"3rd Tuesday",city:"Los Angeles",time:"7:00am – 9:00am"},
  {region:"LA Westside",type:"Home",name:"Century City 2",leader:"Jeffrey Wolf",day:"1st Thursday",city:"Los Angeles",time:"7:00am – 9:00am"},
  {region:"LA Westside",type:"Home",name:"Century City 3",leader:"Ilan Heimanson",day:"4th Wednesday",city:"Los Angeles",time:"7:00am – 9:00am"},
  {region:"LA Westside",type:"Home",name:"Century City 4",leader:"Colin Dun",day:"4th Friday",city:"Los Angeles",time:"7:00am – 9:00am"},
  {region:"LA Westside",type:"Home",name:"Century City 5",leader:"Nick Wolf",day:"2nd Wednesday",city:"Los Angeles",time:"7:00am – 9:00am"},
  {region:"LA Westside",type:"Home",name:"Century City 6",leader:"Marlo Van Oorschot",day:"3rd Thursday",city:"Los Angeles",time:"7:00am – 9:00am"},
  {region:"LA Westside",type:"Home",name:"Century City 7",leader:"Robert Heller",day:"1st Thursday",city:"Los Angeles",time:"7:00am – 9:00am"},
  {region:"LA Westside",type:"Home",name:"Culver City",leader:"Richard Clayman",day:"4th Tuesday",city:"Playa Vista",time:"7:00am – 9:00am"},
  {region:"LA Westside",type:"Home",name:"Entertainment 1",leader:"Joey Behrstock",day:"2nd Tuesday",city:"Los Angeles",time:"7:00am – 9:00am"},
  {region:"LA Westside",type:"Home",name:"Entertainment 2",leader:"Stephen Smith",day:"3rd Thursday",city:"Los Angeles",time:"7:00am – 9:00am"},
  {region:"LA Westside",type:"Home",name:"Manhattan Beach",leader:"Eric Gharakanian",day:"1st Wednesday",city:"Manhattan Beach",time:"11:30am – 1:30pm"},
  {region:"LA Westside",type:"Home",name:"Pacific Business Corridor",leader:"Carol Glover",day:"1st Thursday",city:"El Segundo",time:"7:00am – 9:00am"},
  {region:"LA Westside",type:"Home",name:"South Bay Classic",leader:"Jesse Laikin",day:"2nd Tuesday",city:"El Segundo",time:"7:00am – 9:00am"},
  {region:"LA Westside",type:"Home",name:"South Bay 2",leader:"Steve Brodhead",day:"3rd Wednesday",city:"El Segundo",time:"7:00am – 9:00am"},
  {region:"LA Westside",type:"Home",name:"South Bay 3",leader:"Anthony Walker",day:"3rd Friday",city:"Torrance",time:"7:00am – 9:00am"},
  {region:"LA Westside",type:"Home",name:"South Bay 4",leader:"Steve Goldstein",day:"3rd Thursday",city:"El Segundo",time:"7:00am – 9:00am"},
  {region:"LA Westside",type:"Home",name:"Silicon Beach 1",leader:"Mark Jaffe",day:"1st Friday",city:"Santa Monica",time:"7:00am – 9:00am"},
  {region:"LA Westside",type:"Home",name:"Silicon Beach 2",leader:"Chris King",day:"1st Tuesday",city:"Santa Monica",time:"7:00am – 9:00am"},
  {region:"LA Westside",type:"Home",name:"Santa Monica 1",leader:"David Wimmer",day:"2nd Thursday",city:"Santa Monica",time:"7:00am – 9:00am"},
  {region:"LA Westside",type:"Home",name:"Santa Monica 2",leader:"Eli Appel",day:"3rd Wednesday",city:"Santa Monica",time:"11:30am – 1:30pm"},
  {region:"LA Westside",type:"Home",name:"Santa Monica 3",leader:"Steven Klein",day:"2nd Wednesday",city:"Santa Monica",time:"7:00am – 9:00am"},
  {region:"LA Westside",type:"Home",name:"Santa Monica 5",leader:"Jamie Cooperstein",day:"3rd Wednesday",city:"Santa Monica",time:"7:00am – 9:00am"},
  {region:"LA Westside",type:"Home",name:"Santa Monica 6",leader:"Jonathan Forster",day:"2nd Friday",city:"Santa Monica",time:"7:00am – 9:00am"},
  {region:"LA Westside",type:"Home",name:"Torrance",leader:"Jennifer Novak",day:"4th Tuesday",city:"Torrance",time:"11:30am – 1:30pm"},
  {region:"LA Westside",type:"Home",name:"Venice",leader:"Kate Pletcher",day:"1st Wednesday",city:"Venice",time:"7:00am – 9:00am"},
  {region:"LA Westside",type:"Home",name:"West Los Angeles",leader:"Justin Krane",day:"4th Thursday",city:"Los Angeles",time:"7:00am – 9:00am"},
  {region:"LA Westside",type:"Home",name:"West Los Angeles 2",leader:"Mayer Nazarian",day:"3rd Friday",city:"Los Angeles",time:"7:00am – 9:00am"},
  {region:"LA Westside",type:"Home",name:"Westside",leader:"Amanda Scott",day:"4th Friday",city:"Los Angeles",time:"7:00am – 9:00am"},
  {region:"LA Westside",type:"Home",name:"Westside 2",leader:"Rances Sainz",day:"1st Tuesday",city:"Los Angeles",time:"7:00am – 9:00am"},
  {region:"LA Westside",type:"Home",name:"Westside 3",leader:"Russell Glazer",day:"1st Friday",city:"Los Angeles",time:"7:00am – 9:00am"},
  {region:"LA Westside",type:"Home",name:"Westwood",leader:"Ji Park",day:"3rd Tuesday",city:"Los Angeles",time:"7:00am – 9:00am"},
  {region:"LA Westside",type:"Home",name:"Westwood Village",leader:"Whit Prouty",day:"2nd Thursday",city:"Los Angeles",time:"7:00am – 9:00am"},
  {region:"LA Westside",type:"Affinity",name:"South Bay Women's",leader:"Laura Bruno",day:"2nd Friday",city:"El Segundo",time:"11:30am – 1:00pm"},
  {region:"LA Westside",type:"Affinity",name:"LAX/Long Beach Real Estate",leader:"Jennifer Goldstein",day:"2nd Wednesday",city:"El Segundo",time:"11:30am – 1:00pm"},
  {region:"LA Westside",type:"Affinity",name:"Capital Markets",leader:"Haze Walker",day:"1st Tuesday",city:"Los Angeles",time:"12:00pm – 1:30pm"},
  {region:"LA Westside",type:"Affinity",name:"Branding, Licensing, and IP",leader:"Harold Weitzberg",day:"3rd Wednesday",city:"Los Angeles",time:"12:30pm – 2:00pm"},
  {region:"LA Westside",type:"Affinity",name:"Family Business",leader:"Sarah Spector",day:"4th Thursday",city:"Los Angeles",time:"12:00pm – 1:30pm"},
  {region:"LA Westside",type:"Affinity",name:"Growth Affinity Group",leader:"Montgomery Zimmerman",day:"3rd Tuesday",city:"Los Angeles",time:"6:45pm – 8:30pm"},
  {region:"LA Westside",type:"Affinity",name:"Healthcare Advisors",leader:"Bill Richardson",day:"1st Tuesday",city:"Los Angeles",time:"7:30am – 9:00am"},
  {region:"LA Westside",type:"Affinity",name:"Innovation",leader:"Mark Wald",day:"2nd Monday",city:"Los Angeles",time:"11:30am – 1:30pm"},
  {region:"LA Westside",type:"Affinity",name:"LA Lawyers and Legal Professionals",leader:"Michele Weiss",day:"2nd Tuesday",city:"Los Angeles",time:"11:30am – 1:30pm"},
  {region:"LA Westside",type:"Affinity",name:"Middle Market",leader:"Lewis Stanton",day:"1st Friday",city:"Los Angeles",time:"12:00pm – 1:15pm"},
  {region:"LA Westside",type:"Affinity",name:"M&A Capital Formation",leader:"Brian Davidoff",day:"4th Tuesday",city:"Los Angeles",time:"7:30am – 9:00am"},
  {region:"LA Westside",type:"Affinity",name:"Non-Profit",leader:"Joan Ford",day:"1st Thursday",city:"Los Angeles",time:"12:00pm – 1:30pm"},
  {region:"LA Westside",type:"Affinity",name:"Real Estate – Greater Los Angeles",leader:"Eric Erenstoft",day:"4th Wednesday",city:"Los Angeles",time:"12:00pm – 1:45pm"},
  {region:"LA Westside",type:"Affinity",name:"Tax Masters",leader:"Al Knobloch",day:"2nd Wednesday",city:"Los Angeles",time:"12:00pm – 1:30pm"},
  {region:"LA Westside",type:"Affinity",name:"Transactions & Transitions",leader:"Dan Fein",day:"3rd Thursday",city:"Los Angeles",time:"11:30am – 1:30pm"},
  {region:"LA Westside",type:"Affinity",name:"Women's (Westside)",leader:"Gail Goldstein",day:"3rd Monday",city:"Los Angeles",time:"12:00pm – 1:30pm"},
  {region:"LA Valley",type:"Home",name:"Calabasas 1",leader:"Scott Anderholt",day:"1st Tuesday",city:"Calabasas",time:"7:30am – 9:00am"},
  {region:"LA Valley",type:"Home",name:"Calabasas 2",leader:"Samantha Scherr",day:"1st Tuesday",city:"Calabasas",time:"11:30am – 1:00pm"},
  {region:"LA Valley",type:"Home",name:"Camarillo 1",leader:"Tom Means",day:"3rd Wednesday",city:"Camarillo",time:"7:30am – 9:00am"},
  {region:"LA Valley",type:"Home",name:"Conejo",leader:"Scott Williams",day:"4th Thursday",city:"Simi Valley",time:"7:30am – 9:00am"},
  {region:"LA Valley",type:"Home",name:"Encino 1",leader:"Jim Felton",day:"1st Wednesday",city:"Encino",time:"7:30am – 9:00am"},
  {region:"LA Valley",type:"Home",name:"Encino 2",leader:"E. Mark Fishman",day:"4th Wednesday",city:"Encino",time:"7:30am – 9:00am"},
  {region:"LA Valley",type:"Home",name:"Encino 3",leader:"Tina Alleguez",day:"2nd Tuesday",city:"Encino",time:"7:30am – 9:00am"},
  {region:"LA Valley",type:"Home",name:"Encino 4",leader:"David Schnider",day:"3rd Tuesday",city:"Encino",time:"7:30am – 9:00am"},
  {region:"LA Valley",type:"Home",name:"Los Angeles Valley 1",leader:"Kristy Melton",day:"2nd Tuesday",city:"LAV/Zoom",time:"7:00am – 9:00am"},
  {region:"LA Valley",type:"Home",name:"Mergers & Acquisitions 2",leader:"David Bonrouhi",day:"4th Thursday",city:"Encino",time:"7:30am – 9:00am"},
  {region:"LA Valley",type:"Home",name:"Moorpark",leader:"Douglas Ridley",day:"1st Wednesday",city:"Moorpark",time:"7:30am – 9:00am"},
  {region:"LA Valley",type:"Home",name:"Oxnard",leader:"James Bean",day:"4th Wednesday",city:"Oxnard",time:"7:30am – 9:00am"},
  {region:"LA Valley",type:"Home",name:"Santa Barbara 1",leader:"Renee Not",day:"1st Thursday",city:"Santa Barbara",time:"7:30am – 9:00am"},
  {region:"LA Valley",type:"Home",name:"Santa Barbara 2",leader:"Jeff Forster",day:"2nd Wednesday",city:"Santa Barbara",time:"11:30am – 1:00pm"},
  {region:"LA Valley",type:"Home",name:"Santa Barbara 3",leader:"Jennifer Duffy",day:"3rd Tuesday",city:"Santa Barbara",time:"11:30am – 1:00pm"},
  {region:"LA Valley",type:"Home",name:"Santa Clarita Valley",leader:"Nikki Hashemi",day:"3rd Thursday",city:"Valencia",time:"7:30am – 9:00am"},
  {region:"LA Valley",type:"Home",name:"Sherman Oaks 1",leader:"Robert Klein",day:"2nd Wednesday",city:"Sherman Oaks",time:"7:30am – 9:00am"},
  {region:"LA Valley",type:"Home",name:"Sherman Oaks 2",leader:"Chris Bandouveris",day:"3rd Friday",city:"Sherman Oaks",time:"7:30am – 9:00am"},
  {region:"LA Valley",type:"Home",name:"Sherman Oaks 3",leader:"Adam Grant",day:"3rd Tuesday",city:"Sherman Oaks",time:"7:30am – 9:00am"},
  {region:"LA Valley",type:"Home",name:"Sherman Oaks 4",leader:"Jesse Israel",day:"3rd Thursday",city:"Sherman Oaks",time:"11:00am – 1:00pm"},
  {region:"LA Valley",type:"Home",name:"Ventura",leader:"John Troxel",day:"2nd Friday",city:"Oxnard",time:"7:30am – 9:00am"},
  {region:"LA Valley",type:"Home",name:"Ventura 2",leader:"Robert Curtis",day:"3rd Friday",city:"Oxnard",time:"7:30am – 9:00am"},
  {region:"LA Valley",type:"Home",name:"Ventura 3",leader:"Kristen Blunt",day:"3rd Thursday",city:"Oxnard",time:"11:30am – 1:00pm"},
  {region:"LA Valley",type:"Home",name:"Ventura 4",leader:"Brenda Allison",day:"2nd Thursday",city:"Oxnard",time:"7:30am – 9:00am"},
  {region:"LA Valley",type:"Home",name:"Warner Center 1",leader:"Janice Miller",day:"1st Thursday",city:"Woodland Hills",time:"7:30am – 9:00am"},
  {region:"LA Valley",type:"Home",name:"Westlake 1",leader:"Davis Blaine",day:"1st Friday",city:"Westlake Village",time:"7:30am – 9:00am"},
  {region:"LA Valley",type:"Home",name:"Westlake 2",leader:"Don Lanson",day:"4th Friday",city:"Westlake Village",time:"7:30am – 9:00am"},
  {region:"LA Valley",type:"Home",name:"Westlake 3",leader:"Adam Treiger",day:"3rd Thursday",city:"Westlake Village",time:"7:30am – 9:00am"},
  {region:"LA Valley",type:"Home",name:"Westlake 4",leader:"Kevin Shaw",day:"2nd Thursday",city:"Westlake Village",time:"7:30am – 9:00am"},
  {region:"LA Valley",type:"Home",name:"Westlake 5",leader:"Brian Sullivan",day:"4th Thursday",city:"Westlake Village",time:"7:30am – 9:00am"},
  {region:"LA Valley",type:"Home",name:"Westlake 6",leader:"Randi Sorenson",day:"2nd Wednesday",city:"Westlake Village",time:"7:30am – 9:00am"},
  {region:"LA Valley",type:"Home",name:"Westlake 7",leader:"Kyle Marks",day:"4th Tuesday",city:"Westlake Village",time:"7:30am – 9:00am"},
  {region:"LA Valley",type:"Home",name:"Westlake 8",leader:"Sarah Reznick",day:"3rd Tuesday",city:"Westlake Village",time:"7:30am – 9:00am"},
  {region:"LA Valley",type:"Home",name:"Woodland Hills 1",leader:"Joe Seetoo",day:"3rd Tuesday",city:"Woodland Hills",time:"7:30am – 9:00am"},
  {region:"LA Valley",type:"Home",name:"Woodland Hills 2",leader:"Rick Pearson",day:"2nd Thursday",city:"Woodland Hills",time:"7:30am – 9:00am"},
  {region:"LA Valley",type:"Home",name:"Woodland Hills 3",leader:"David Jacobs",day:"4th Wednesday",city:"Woodland Hills",time:"7:30am – 9:00am"},
  {region:"LA Valley",type:"Home",name:"Woodland Hills 4",leader:"Jeff Kobulnick",day:"2nd Wednesday",city:"Woodland Hills",time:"7:30am – 9:00am"},
  {region:"LA Valley",type:"Affinity",name:"SoCal Cannabis",leader:"Greg Hill",day:"4th Tuesday",city:"Woodland Hills",time:"12:00pm – 1:30pm"},
  {region:"LA Valley",type:"Affinity",name:"Conejo Valley Real Estate",leader:"Bruce Stein",day:"4th Thursday",city:"Westlake",time:"12:00pm – 1:30pm"},
  {region:"LA Valley",type:"Affinity",name:"Valley Distributors & Manufacturers",leader:"Jim Twerdahl",day:"2nd Wednesday",city:"Encino",time:"12:00pm – 1:30pm"},
  {region:"LA Valley",type:"Affinity",name:"Valley Estate and Succession Planning",leader:"Heath Goldman",day:"1st Tuesday",city:"Woodland Hills",time:"12:00pm – 1:30pm"},
  {region:"LA Valley",type:"Affinity",name:"Valley Business Professional Services",leader:"David Hilton",day:"3rd Wednesday",city:"Woodland Hills",time:"12:00pm – 1:30pm"},
  {region:"LA Valley",type:"Affinity",name:"Valley Lawyers",leader:"Jacob Stein",day:"3rd Tuesday",city:"Encino",time:"12:00pm – 1:30pm"},
  {region:"LA Valley",type:"Affinity",name:"Valley Real Estate",leader:"Aaron Belliston",day:"2nd Thursday",city:"Encino",time:"12:00pm – 1:30pm"},
  {region:"LA Valley",type:"Affinity",name:"Valley Women's",leader:"Regina Korrossy",day:"1st Wednesday",city:"LAV",time:"7:00am – 9:00am"},
  {region:"LA Valley",type:"Affinity",name:"Start Up and Entrepreneurship",leader:"Marc Honorof",day:"4th Friday",city:"Westlake Village",time:"11:30am – 1:30pm"},
  {region:"LA Valley",type:"Affinity",name:"Westlake Estate and Succession Planning",leader:"Louis Ashamallah",day:"1st Friday",city:"Westlake Village",time:"12:00pm – 1:30pm"},
  {region:"LA Valley",type:"Affinity",name:"Westlake Lawyers",leader:"Laura Withrow",day:"3rd Friday",city:"Westlake Village",time:"12:00pm – 1:30pm"},
];

// ── Hub Registrations (scraped from hub.provisors.com, Feb 20 2026) ──
// These are Trevor's actual registered meetings — shown on calendar as green "Hub Registered" slots
const HUB_REGISTRATIONS = [
  {eventName:'SoCal Cannabis Affinity Group',location:'Virtual',startDate:'Tuesday, February 24, 2026, 11:30 AM',endDate:'Tuesday, February 24, 2026, 01:30 PM',eventType:'Affinity Group Meeting'},
  {eventName:'Real Estate Group - Greater Los Angeles',location:'In-Person',startDate:'Wednesday, February 25, 2026, 12:00 PM',endDate:'Wednesday, February 25, 2026, 01:45 PM',eventType:'Affinity Group Meeting'},
  {eventName:'Westside',location:'Virtual',startDate:'Friday, February 27, 2026, 07:30 AM',endDate:'Friday, February 27, 2026, 09:00 AM',eventType:'Home Group Meeting'},
  {eventName:'Start Up and Entrepreneurship Affinity Group',location:'Virtual',startDate:'Friday, February 27, 2026, 11:50 AM',endDate:'Friday, February 27, 2026, 01:30 PM',eventType:'Affinity Group Meeting'},
  {eventName:'Silicon Beach 2',location:'In-Person & Virtual',startDate:'Tuesday, March 03, 2026, 07:30 AM',endDate:'Tuesday, March 03, 2026, 09:00 AM',eventType:'Home Group Meeting'},
  {eventName:'Capital Markets Affinity Group',location:'Virtual',startDate:'Tuesday, March 03, 2026, 12:00 PM',endDate:'Tuesday, March 03, 2026, 01:30 PM',eventType:'Affinity Group Meeting'},
  {eventName:'Non-Profit Affinity Group',location:'Virtual',startDate:'Thursday, March 05, 2026, 12:00 PM',endDate:'Thursday, March 05, 2026, 01:00 PM',eventType:'Affinity Group Meeting'},
  {eventName:'Westside 3',location:'In-Person',startDate:'Friday, March 06, 2026, 07:30 AM',endDate:'Friday, March 06, 2026, 09:00 AM',eventType:'Home Group Meeting'},
  {eventName:'Middle Market Affinity Group',location:'In-Person',startDate:'Friday, March 06, 2026, 12:00 PM',endDate:'Friday, March 06, 2026, 01:30 PM',eventType:'Affinity Group Meeting'},
  {eventName:'Innovation Affinity Group',location:'Virtual',startDate:'Monday, March 09, 2026, 11:30 AM',endDate:'Monday, March 09, 2026, 01:30 PM',eventType:'Affinity Group Meeting'},
  {eventName:'San Gabriel Valley Real Estate Affinity Group',location:'In-Person',startDate:'Tuesday, March 10, 2026, 12:00 PM',endDate:'Tuesday, March 10, 2026, 01:30 PM',eventType:'Affinity Group Meeting'},
  {eventName:'Century City 5',location:'In-Person',startDate:'Wednesday, March 11, 2026, 07:30 AM',endDate:'Wednesday, March 11, 2026, 09:00 AM',eventType:'Home Group Meeting'},
  {eventName:'LAX/Long Beach Real Estate Affinity',location:'Virtual',startDate:'Wednesday, March 11, 2026, 11:00 AM',endDate:'Wednesday, March 11, 2026, 01:00 PM',eventType:'Affinity Group Meeting'},
  {eventName:'Westwood Village',location:'In-Person',startDate:'Thursday, March 12, 2026, 07:30 AM',endDate:'Thursday, March 12, 2026, 09:00 AM',eventType:'Home Group Meeting'},
  {eventName:'Valley Real Estate Affinity Group',location:'In-Person',startDate:'Thursday, March 12, 2026, 12:00 PM',endDate:'Thursday, March 12, 2026, 01:30 PM',eventType:'Affinity Group Meeting'},
  {eventName:'Mid City',location:'In-Person',startDate:'Friday, March 13, 2026, 07:30 AM',endDate:'Friday, March 13, 2026, 09:00 AM',eventType:'Home Group Meeting'},
  {eventName:'Hollywood',location:'In-Person',startDate:'Tuesday, March 17, 2026, 07:00 AM',endDate:'Tuesday, March 17, 2026, 09:00 AM',eventType:'Home Group Meeting'},
  {eventName:'Beverly Hills 2',location:'In-Person & Virtual',startDate:'Wednesday, March 18, 2026, 07:30 AM',endDate:'Wednesday, March 18, 2026, 09:00 AM',eventType:'Home Group Meeting'},
  {eventName:'Rancho Park',location:'In-Person',startDate:'Thursday, March 19, 2026, 07:30 AM',endDate:'Thursday, March 19, 2026, 09:00 AM',eventType:'Home Group Meeting'},
  {eventName:'Culver City',location:'In-Person',startDate:'Tuesday, March 24, 2026, 07:30 AM',endDate:'Tuesday, March 24, 2026, 09:00 AM',eventType:'Home Group Meeting'},
  {eventName:'SoCal Cannabis Affinity Group',location:'Virtual',startDate:'Tuesday, March 24, 2026, 11:30 AM',endDate:'Tuesday, March 24, 2026, 01:30 PM',eventType:'Affinity Group Meeting'},
  {eventName:'Real Estate Group - Greater Los Angeles',location:'In-Person',startDate:'Wednesday, March 25, 2026, 12:00 PM',endDate:'Wednesday, March 25, 2026, 01:45 PM',eventType:'Affinity Group Meeting'},
  {eventName:'Westside',location:'Virtual',startDate:'Friday, March 27, 2026, 07:30 AM',endDate:'Friday, March 27, 2026, 09:00 AM',eventType:'Home Group Meeting'},
  {eventName:'Start Up and Entrepreneurship Affinity Group',location:'Virtual',startDate:'Friday, March 27, 2026, 11:50 AM',endDate:'Friday, March 27, 2026, 01:30 PM',eventType:'Affinity Group Meeting'},
  {eventName:'Non-Profit Affinity Group',location:'Virtual',startDate:'Thursday, April 02, 2026, 12:00 PM',endDate:'Thursday, April 02, 2026, 01:00 PM',eventType:'Affinity Group Meeting'},
  {eventName:'Middle Market Affinity Group',location:'In-Person',startDate:'Friday, April 03, 2026, 12:00 PM',endDate:'Friday, April 03, 2026, 01:30 PM',eventType:'Affinity Group Meeting'},
  {eventName:'Capital Markets Affinity Group',location:'Virtual',startDate:'Tuesday, April 07, 2026, 12:00 PM',endDate:'Tuesday, April 07, 2026, 01:30 PM',eventType:'Affinity Group Meeting'},
  {eventName:'Beverly Hills 4',location:'In-Person',startDate:'Wednesday, April 08, 2026, 07:30 AM',endDate:'Wednesday, April 08, 2026, 09:00 AM',eventType:'Home Group Meeting'},
  {eventName:'LAX/Long Beach Real Estate Affinity',location:'In-Person',startDate:'Wednesday, April 08, 2026, 11:00 AM',endDate:'Wednesday, April 08, 2026, 01:00 PM',eventType:'Affinity Group Meeting'},
  {eventName:'Valley Real Estate Affinity Group',location:'In-Person',startDate:'Thursday, April 09, 2026, 12:00 PM',endDate:'Thursday, April 09, 2026, 01:30 PM',eventType:'Affinity Group Meeting'},
  {eventName:'Innovation Affinity Group',location:'Virtual',startDate:'Monday, April 13, 2026, 11:30 AM',endDate:'Monday, April 13, 2026, 01:30 PM',eventType:'Affinity Group Meeting'},
  {eventName:'Century City 6',location:'Virtual',startDate:'Thursday, April 16, 2026, 07:30 AM',endDate:'Thursday, April 16, 2026, 09:00 AM',eventType:'Home Group Meeting'},
  {eventName:'Hollywood',location:'In-Person',startDate:'Tuesday, April 21, 2026, 07:00 AM',endDate:'Tuesday, April 21, 2026, 09:00 AM',eventType:'Home Group Meeting'},
  {eventName:'Real Estate Group - Greater Los Angeles',location:'In-Person',startDate:'Wednesday, April 22, 2026, 12:00 PM',endDate:'Wednesday, April 22, 2026, 01:45 PM',eventType:'Affinity Group Meeting'},
  {eventName:'Westside',location:'Virtual',startDate:'Friday, April 24, 2026, 07:30 AM',endDate:'Friday, April 24, 2026, 09:00 AM',eventType:'Home Group Meeting'},
  {eventName:'Start Up and Entrepreneurship Affinity Group',location:'Virtual',startDate:'Friday, April 24, 2026, 11:50 AM',endDate:'Friday, April 24, 2026, 01:30 PM',eventType:'Affinity Group Meeting'},
  {eventName:'SoCal Cannabis Affinity Group',location:'Virtual',startDate:'Tuesday, April 28, 2026, 11:30 AM',endDate:'Tuesday, April 28, 2026, 01:30 PM',eventType:'Affinity Group Meeting'},
  {eventName:'Capital Markets Affinity Group',location:'Virtual',startDate:'Tuesday, May 05, 2026, 12:00 PM',endDate:'Tuesday, May 05, 2026, 01:30 PM',eventType:'Affinity Group Meeting'},
  {eventName:'Non-Profit Affinity Group',location:'Virtual',startDate:'Thursday, May 07, 2026, 12:00 PM',endDate:'Thursday, May 07, 2026, 01:00 PM',eventType:'Affinity Group Meeting'},
  {eventName:'Innovation Affinity Group',location:'Virtual',startDate:'Monday, May 11, 2026, 11:30 AM',endDate:'Monday, May 11, 2026, 01:30 PM',eventType:'Affinity Group Meeting'},
  {eventName:'Beverly Hills 4',location:'In-Person',startDate:'Wednesday, May 13, 2026, 07:30 AM',endDate:'Wednesday, May 13, 2026, 09:00 AM',eventType:'Home Group Meeting'},
  {eventName:'Tax Masters Affinity Group',location:'Virtual',startDate:'Wednesday, May 13, 2026, 11:45 AM',endDate:'Wednesday, May 13, 2026, 01:30 PM',eventType:'Affinity Group Meeting'},
  {eventName:'Valley Real Estate Affinity Group',location:'In-Person',startDate:'Thursday, May 14, 2026, 12:00 PM',endDate:'Thursday, May 14, 2026, 01:30 PM',eventType:'Affinity Group Meeting'},
  {eventName:'Hollywood',location:'In-Person',startDate:'Tuesday, May 19, 2026, 07:00 AM',endDate:'Tuesday, May 19, 2026, 09:00 AM',eventType:'Home Group Meeting'},
  {eventName:'Century City 6',location:'In-Person',startDate:'Thursday, May 21, 2026, 07:30 AM',endDate:'Thursday, May 21, 2026, 09:00 AM',eventType:'Home Group Meeting'},
  {eventName:'Start Up and Entrepreneurship Affinity Group',location:'Virtual',startDate:'Friday, May 22, 2026, 11:50 AM',endDate:'Friday, May 22, 2026, 01:30 PM',eventType:'Affinity Group Meeting'},
  {eventName:'SoCal Cannabis Affinity Group',location:'Virtual',startDate:'Tuesday, May 26, 2026, 11:30 AM',endDate:'Tuesday, May 26, 2026, 01:30 PM',eventType:'Affinity Group Meeting'},
  {eventName:'Real Estate Group - Greater Los Angeles',location:'In-Person',startDate:'Wednesday, May 27, 2026, 12:00 PM',endDate:'Wednesday, May 27, 2026, 01:45 PM',eventType:'Affinity Group Meeting'},
  {eventName:'Capital Markets Affinity Group',location:'Virtual',startDate:'Tuesday, June 02, 2026, 12:00 PM',endDate:'Tuesday, June 02, 2026, 01:30 PM',eventType:'Affinity Group Meeting'},
  {eventName:'Non-Profit Affinity Group',location:'Virtual',startDate:'Thursday, June 04, 2026, 12:00 PM',endDate:'Thursday, June 04, 2026, 01:00 PM',eventType:'Affinity Group Meeting'},
  {eventName:'Innovation Affinity Group',location:'Virtual',startDate:'Monday, June 08, 2026, 11:30 AM',endDate:'Monday, June 08, 2026, 01:30 PM',eventType:'Affinity Group Meeting'},
  {eventName:'San Gabriel Valley Real Estate Affinity Group',location:'In-Person',startDate:'Tuesday, June 09, 2026, 12:00 PM',endDate:'Tuesday, June 09, 2026, 01:30 PM',eventType:'Affinity Group Meeting'},
  {eventName:'LAX/Long Beach Real Estate Affinity',location:'Virtual',startDate:'Wednesday, June 10, 2026, 11:00 AM',endDate:'Wednesday, June 10, 2026, 01:00 PM',eventType:'Affinity Group Meeting'},
  {eventName:'Valley Real Estate Affinity Group',location:'In-Person',startDate:'Thursday, June 11, 2026, 12:00 PM',endDate:'Thursday, June 11, 2026, 01:30 PM',eventType:'Affinity Group Meeting'},
  {eventName:'Mid City',location:'In-Person',startDate:'Friday, June 12, 2026, 07:30 AM',endDate:'Friday, June 12, 2026, 09:00 AM',eventType:'Home Group Meeting'},
  {eventName:'Hollywood',location:'Virtual',startDate:'Tuesday, June 16, 2026, 07:00 AM',endDate:'Tuesday, June 16, 2026, 09:00 AM',eventType:'Home Group Meeting'},
  {eventName:'SoCal Cannabis Affinity Group',location:'Virtual',startDate:'Tuesday, June 23, 2026, 11:30 AM',endDate:'Tuesday, June 23, 2026, 01:30 PM',eventType:'Affinity Group Meeting'},
  {eventName:'Real Estate Group - Greater Los Angeles',location:'In-Person',startDate:'Wednesday, June 24, 2026, 12:00 PM',endDate:'Wednesday, June 24, 2026, 01:45 PM',eventType:'Affinity Group Meeting'},
  {eventName:'Start Up and Entrepreneurship Affinity Group',location:'Virtual',startDate:'Friday, June 26, 2026, 11:50 AM',endDate:'Friday, June 26, 2026, 01:30 PM',eventType:'Affinity Group Meeting'},
  {eventName:'Non-Profit Affinity Group',location:'Virtual',startDate:'Thursday, July 02, 2026, 12:00 PM',endDate:'Thursday, July 02, 2026, 01:00 PM',eventType:'Affinity Group Meeting'},
  {eventName:'Capital Markets Affinity Group',location:'Virtual',startDate:'Tuesday, July 07, 2026, 12:00 PM',endDate:'Tuesday, July 07, 2026, 01:30 PM',eventType:'Affinity Group Meeting'},
  {eventName:'LAX/Long Beach Real Estate Affinity',location:'In-Person',startDate:'Wednesday, July 08, 2026, 11:00 AM',endDate:'Wednesday, July 08, 2026, 01:00 PM',eventType:'Affinity Group Meeting'},
  {eventName:'Valley Real Estate Affinity Group',location:'In-Person',startDate:'Thursday, July 09, 2026, 12:00 PM',endDate:'Thursday, July 09, 2026, 01:30 PM',eventType:'Affinity Group Meeting'},
  {eventName:'Innovation Affinity Group',location:'Virtual',startDate:'Monday, July 13, 2026, 11:30 AM',endDate:'Monday, July 13, 2026, 01:30 PM',eventType:'Affinity Group Meeting'},
  {eventName:'Hollywood',location:'In-Person',startDate:'Tuesday, July 21, 2026, 07:00 AM',endDate:'Tuesday, July 21, 2026, 09:00 AM',eventType:'Home Group Meeting'},
  {eventName:'Real Estate Group - Greater Los Angeles',location:'In-Person',startDate:'Wednesday, July 22, 2026, 12:00 PM',endDate:'Wednesday, July 22, 2026, 01:45 PM',eventType:'Affinity Group Meeting'},
  {eventName:'Start Up and Entrepreneurship Affinity Group',location:'Virtual',startDate:'Friday, July 24, 2026, 11:50 AM',endDate:'Friday, July 24, 2026, 01:30 PM',eventType:'Affinity Group Meeting'},
  {eventName:'SoCal Cannabis Affinity Group',location:'Virtual',startDate:'Tuesday, July 28, 2026, 11:30 AM',endDate:'Tuesday, July 28, 2026, 01:30 PM',eventType:'Affinity Group Meeting'},
];

// ── Parse embedded Hub registrations on load ──
// Match each to a GROUPS entry and set format data
function initHubRegistrations() {
  HUB_REGISTRATIONS.forEach(reg => {
    // Parse date
    const dm = reg.startDate.match(/\w+,\s+(\w+)\s+(\d+),\s+(\d{4}),?\s+(\d+:\d+\s+\w+)/);
    if (dm) reg.parsedDate = new Date(`${dm[1]} ${dm[2]}, ${dm[3]} ${dm[4]}`);
    // Match to group
    reg.matchedGroupIdx = matchHubToGroup(reg.eventName);
    reg.eventType = reg.eventType.includes('Home') ? 'Home' : 'Affinity';
    // Set format on the matched group
    if (reg.matchedGroupIdx >= 0) {
      const loc = reg.location;
      if (loc === 'Virtual' || loc === 'In-Person' || loc === 'In-Person & Virtual') {
        GROUPS[reg.matchedGroupIdx].format = loc;
      }
      // Auto-select matched groups
      selectedMeetings.add(reg.matchedGroupIdx);
    }
  });
  // Set as the default hubRegistrations
  hubRegistrations = HUB_REGISTRATIONS;
}

// ── Assign coordinates with jitter ──
const cityGroupCount = {}, cityGroupIndex = {};
// Count groups per location key (neighborhood or city) for jitter
const locationKey = g => NEIGHBORHOOD_COORDS[g.name] ? g.name : g.city;
const locGroupCount = {}, locGroupIndex = {};
GROUPS.forEach(g => { const k = locationKey(g); locGroupCount[k] = (locGroupCount[k] || 0) + 1; });
GROUPS.forEach(g => {
  const k = locationKey(g);
  locGroupIndex[k] = (locGroupIndex[k] || 0);
  // Use neighborhood coords if available, otherwise city coords
  const base = NEIGHBORHOOD_COORDS[g.name] || CITY_COORDS[g.city] || CITY_COORDS["Los Angeles"];
  // Only jitter if multiple groups share the exact same base coords
  const coords = locGroupCount[k] > 1
    ? jitter(base, locGroupIndex[k], locGroupCount[k])
    : base;
  g.lat = coords[0]; g.lng = coords[1]; g.distance = null;
  locGroupIndex[k]++;
  // Default format: infer from city name, otherwise unknown (Hub sync will override)
  if (g.city.toLowerCase().includes('zoom') || g.city === 'LAV') {
    g.format = 'Virtual';
  } else {
    g.format = ''; // unknown until Hub syncs
  }
});

// ── State ──
let userLat = null, userLng = null, userMarker = null, markers = [], filtered = [...GROUPS];
const selectedMeetings = new Set();
let calYear, calMonth;
// My Home Group — stored as group index, default to Hollywood
let myHomeGroupIdx = parseInt(localStorage.getItem('provisors-home-group') ?? '-1');
if (myHomeGroupIdx < 0) { myHomeGroupIdx = GROUPS.findIndex(g => g.name === 'Hollywood'); localStorage.setItem('provisors-home-group', myHomeGroupIdx); }
function setMyHomeGroup(idx) { myHomeGroupIdx = idx; localStorage.setItem('provisors-home-group', idx); renderTable(); renderCalendar(); renderMyMeetings(); }
const now = new Date(); calYear = now.getFullYear(); calMonth = now.getMonth();

// ── View Switching ──
function switchView(view) {
  document.querySelectorAll('.view-tab').forEach(t => t.classList.toggle('active', t.dataset.view === view));
  document.getElementById('view-map').className = 'view-pane ' + (view === 'map' ? 'visible' : 'hidden');
  document.getElementById('view-calendar').className = 'view-pane ' + (view === 'calendar' ? 'visible' : 'hidden');
  if (view === 'map') setTimeout(() => map.invalidateSize(), 100);
  if (view === 'calendar') renderCalendar();
}

// ── Map Init ──
const map = L.map('map').setView([34.05, -118.40], 10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors', maxZoom: 18
}).addTo(map);

function createIcon(type, size = 12) {
  return L.divIcon({
    className: type === 'Home' ? 'home-marker' : type === 'user' ? 'user-marker' : 'affinity-marker',
    iconSize: [size, size], iconAnchor: [size/2, size/2]
  });
}

// ── Distance (Haversine) ──
function haversine(lat1, lon1, lat2, lon2) {
  const R = 3958.8, dLat = (lat2 - lat1) * Math.PI / 180, dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}
function updateDistances() { GROUPS.forEach(g => { g.distance = userLat !== null ? haversine(userLat, userLng, g.lat, g.lng) : null; }); }

async function geocodeAddress() {
  const addr = document.getElementById('user-address').value.trim();
  if (!addr) return;
  try {
    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}&limit=1`);
    const data = await res.json();
    if (!data.length) { alert('Address not found.'); return; }
    setUserLocation(parseFloat(data[0].lat), parseFloat(data[0].lon), addr);
  } catch(e) { alert('Geocoding error: ' + e.message); }
}
function useMyLocation() {
  if (!navigator.geolocation) { alert('Geolocation not supported'); return; }
  navigator.geolocation.getCurrentPosition(pos => {
    setUserLocation(pos.coords.latitude, pos.coords.longitude, 'Your Location');
    document.getElementById('user-address').value = `${pos.coords.latitude.toFixed(4)}, ${pos.coords.longitude.toFixed(4)}`;
  }, () => alert('Could not get location.'));
}
function setUserLocation(lat, lng, label) {
  userLat = lat; userLng = lng;
  if (userMarker) map.removeLayer(userMarker);
  userMarker = L.marker([lat, lng], { icon: createIcon('user', 16), zIndexOffset: 1000 })
    .addTo(map).bindPopup(`<strong>${label}</strong><br>Your location`);
  updateDistances();
  document.getElementById('sort-by').value = 'distance';
  applyFilters(); map.setView([lat, lng], 11);
}

// ── Day helpers ──
const DAY_ORDER = { 'Monday':1,'Tuesday':2,'Wednesday':3,'Thursday':4,'Friday':5 };
const WEEK_ORDER = { '1st':1,'2nd':2,'3rd':3,'4th':4 };
const DAY_NAMES = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
const MONTH_NAMES = ['January','February','March','April','May','June','July','August','September','October','November','December'];

function daySort(dayStr) { const p = dayStr.split(' '); return (WEEK_ORDER[p[0]]||0)*10 + (DAY_ORDER[p[1]]||0); }

// Get the Nth weekday of a month. Returns date or null.
function getNthWeekday(year, month, nth, weekday) {
  // weekday: 0=Sun..6=Sat; nth: 1-4
  const first = new Date(year, month, 1);
  let day = 1 + ((weekday - first.getDay() + 7) % 7);
  day += (nth - 1) * 7;
  if (day > new Date(year, month + 1, 0).getDate()) return null;
  return new Date(year, month, day);
}

// Parse "2nd Tuesday" → { nth, weekdayIndex }
function parseDayPattern(dayStr) {
  const parts = dayStr.split(' ');
  const nth = WEEK_ORDER[parts[0]];
  const wdi = DAY_ORDER[parts[1]]; // Mon=1..Fri=5
  if (!nth || wdi === undefined) return null;
  return { nth, weekdayIndex: wdi }; // JS weekday: Mon=1
}

// Get time slot: 'morning', 'lunch', 'evening'
function getTimeSlot(timeStr) {
  // Only look at the START time (before the dash/separator)
  const startTime = timeStr.split(/[–—-]/)[0].trim().toLowerCase();
  const h = parseInt(startTime);
  const isPm = startTime.includes('pm') && h !== 12;
  const hour = isPm ? h + 12 : (h === 12 && startTime.includes('pm')) ? 12 : h;
  if (hour < 11) return 'morning';
  if (hour < 17) return 'lunch';
  return 'evening';
}

// ── Filter & Render ──
function applyFilters() {
  const search = document.getElementById('search').value.toLowerCase();
  const region = document.getElementById('filter-region').value;
  const type = document.getElementById('filter-type').value;
  const day = document.getElementById('filter-day').value;
  const format = document.getElementById('filter-format').value;
  const sortField = document.getElementById('sort-by').value;

  // If a calendar slot filter is active, use that instead of normal filters
  if (slotFilterIndices) {
    filtered = GROUPS.filter((g, idx) => slotFilterIndices.has(idx));
  } else {
    filtered = GROUPS.filter(g => {
      if (region && g.region !== region) return false;
      if (type && g.type !== type) return false;
      if (day && !g.day.includes(day)) return false;
      if (format && g.format !== format) return false;
      if (search && !(g.name.toLowerCase().includes(search) || g.leader.toLowerCase().includes(search) || g.city.toLowerCase().includes(search) || g.region.toLowerCase().includes(search))) return false;
      return true;
    });
  }

  filtered.sort((a, b) => {
    switch(sortField) {
      case 'distance': return (a.distance??9999) - (b.distance??9999);
      case 'city': return a.city.localeCompare(b.city);
      case 'day': return daySort(a.day) - daySort(b.day);
      case 'type': return a.type.localeCompare(b.type);
      case 'time': return a.time.localeCompare(b.time);
      case 'format': return (a.format||'zzz').localeCompare(b.format||'zzz');
      default: return a.name.localeCompare(b.name);
    }
  });
  renderTable(); renderMarkers(); updateStats(); renderCalendar();
}

function sortBy(field) { document.getElementById('sort-by').value = field; applyFilters(); }

function renderTable() {
  const tbody = document.getElementById('table-body');
  tbody.innerHTML = filtered.map(g => {
    const idx = GROUPS.indexOf(g);
    const checked = selectedMeetings.has(idx) ? 'checked' : '';
    const fmtBadge = g.format === 'Virtual' ? '<span class="badge virtual">Virtual</span>'
      : g.format === 'In-Person' ? '<span class="badge in-person">In-Person</span>'
      : g.format === 'In-Person & Virtual' ? '<span class="badge hybrid">Hybrid</span>'
      : '<span style="color:#aaa;font-size:10px">—</span>';
    return `<tr onclick="focusGroup(${idx})" data-idx="${idx}" class="${selectedMeetings.has(idx)?'selected':''}">
      <td class="cb-col" onclick="event.stopPropagation()"><input type="checkbox" ${checked} onchange="toggleSelection(${idx},this.checked)" /></td>
      <td><strong>${g.name}</strong><br><span style="color:#636e72;font-size:11px">${g.leader}</span></td>
      <td><span class="badge ${g.type.toLowerCase()}">${g.type}</span></td>
      <td>${g.city}</td>
      <td style="white-space:nowrap">${g.day}</td>
      <td style="white-space:nowrap">${g.time}</td>
      <td>${fmtBadge}</td>
      <td class="distance-cell">${g.distance!==null?g.distance.toFixed(1)+' mi':'—'}</td></tr>`;
  }).join('');
  const footerText = slotFilterLabel
    ? `Showing ${filtered.length} groups — ${slotFilterLabel}`
    : `Showing ${filtered.length} of ${GROUPS.length} groups`;
  document.getElementById('table-footer').textContent = footerText;
}

function renderMarkers() {
  markers.forEach(m => map.removeLayer(m)); markers = [];
  filtered.forEach(g => {
    const idx = GROUPS.indexOf(g);
    const m = L.marker([g.lat, g.lng], { icon: createIcon(g.type) }).addTo(map);
    const distHtml = g.distance !== null ? `<div class="popup-distance">${g.distance.toFixed(1)} miles from you</div>` : '';
    const isSel = selectedMeetings.has(idx);
    const btnStyle = isSel ? 'background:#e8f0e8;color:#27ae60;border:1px solid #27ae60;' : 'background:#153D63;color:white;border:none;';
    const fmtTag = g.format === 'Virtual' ? ' <span style="color:#0077b6;font-weight:600;font-size:11px;">&#128187; Virtual</span>'
      : g.format === 'In-Person' ? ' <span style="color:#1a7f37;font-weight:600;font-size:11px;">&#128205; In-Person</span>' : '';
    m.bindPopup(`<strong>${g.name}</strong>${fmtTag}<br><span style="color:#636e72">${g.type} Group &bull; ${g.region}</span><br>
      Leader: ${g.leader}<br>${g.day} &bull; ${g.time}<br>${g.city}${distHtml}
      <div style="margin-top:8px"><button onclick="toggleSelectionFromPopup(${idx})" style="${btnStyle}padding:4px 10px;border-radius:4px;font-size:11px;font-weight:600;cursor:pointer;">${isSel?'In My Meetings':'Add to My Meetings'}</button></div>`);
    markers.push(m);
  });
}

function focusGroup(idx) {
  const g = GROUPS[idx]; map.setView([g.lat, g.lng], 13);
  const mi = filtered.indexOf(g);
  if (mi >= 0 && markers[mi]) markers[mi].openPopup();
  document.querySelectorAll('.table-wrap tr.selected').forEach(r => r.classList.remove('selected'));
  const row = document.querySelector(`tr[data-idx="${idx}"]`);
  if (row) { row.classList.add('selected'); row.scrollIntoView({ block: 'nearest' }); }
  switchView('map');
}

function updateStats() {
  const home = filtered.filter(g => g.type === 'Home').length;
  const affinity = filtered.filter(g => g.type === 'Affinity').length;
  const cities = new Set(filtered.map(g => g.city)).size;
  document.getElementById('stat-total').textContent = filtered.length;
  document.getElementById('stat-home').textContent = home;
  document.getElementById('stat-affinity').textContent = affinity;
  document.getElementById('stat-cities').textContent = cities;
  document.getElementById('stat-selected').textContent = selectedMeetings.size;
}

// ── Selection / My Meetings ──
function toggleSelection(idx, checked) {
  if (checked) selectedMeetings.add(idx); else selectedMeetings.delete(idx);
  renderMyMeetings(); saveSelections(); renderCalendar();
  const row = document.querySelector(`tr[data-idx="${idx}"]`);
  if (row) row.classList.toggle('selected', checked);
}
function removeSelection(idx) {
  selectedMeetings.delete(idx); renderMyMeetings(); saveSelections(); renderCalendar();
  const row = document.querySelector(`tr[data-idx="${idx}"]`);
  if (row) { row.classList.remove('selected'); const cb = row.querySelector('input[type="checkbox"]'); if (cb) cb.checked = false; }
}
function toggleSelectionFromPopup(idx) {
  const sel = !selectedMeetings.has(idx);
  if (sel) selectedMeetings.add(idx); else selectedMeetings.delete(idx);
  renderMyMeetings(); updateStats(); saveSelections(); renderCalendar();
  const row = document.querySelector(`tr[data-idx="${idx}"]`);
  if (row) { row.classList.toggle('selected', sel); const cb = row.querySelector('input[type="checkbox"]'); if (cb) cb.checked = sel; }
  renderMarkers();
}
function clearAllSelections() {
  selectedMeetings.clear(); renderMyMeetings(); saveSelections(); renderCalendar();
  document.querySelectorAll('.table-wrap input[type="checkbox"]').forEach(cb => cb.checked = false);
  document.querySelectorAll('.table-wrap tr.selected').forEach(r => r.classList.remove('selected'));
}
function renderMyMeetings() {
  const body = document.getElementById('my-meetings-body');
  const count = document.getElementById('my-meetings-count');
  const panel = document.getElementById('my-meetings-panel');
  count.textContent = selectedMeetings.size;
  document.getElementById('stat-selected').textContent = selectedMeetings.size;
  if (selectedMeetings.size === 0) { body.innerHTML = '<div class="my-meetings-empty">Check meetings above to add them to your list</div>'; return; }
  if (selectedMeetings.size === 1 && panel.classList.contains('collapsed')) { panel.classList.remove('collapsed'); panel.classList.add('expanded'); }
  const sorted = [...selectedMeetings].sort((a, b) => daySort(GROUPS[a].day) - daySort(GROUPS[b].day));
  body.innerHTML = sorted.map(idx => {
    const g = GROUPS[idx]; const dist = g.distance !== null ? ` &bull; ${g.distance.toFixed(1)} mi` : '';
    return `<div class="my-meeting-item"><div class="my-meeting-info"><strong>${g.name}</strong>
      <div class="meta">${g.day} &bull; ${g.time} &bull; ${g.city}${dist}</div></div>
      <button class="my-meeting-remove" onclick="removeSelection(${idx})" title="Remove">&times;</button></div>`;
  }).join('');
}
function toggleMyMeetings() {
  const p = document.getElementById('my-meetings-panel'); p.classList.toggle('collapsed'); p.classList.toggle('expanded');
}
function openHub() { window.open('https://hub.provisors.com/personalsnapshot', '_blank'); }
function saveSelections() { localStorage.setItem('provisors-selected', JSON.stringify([...selectedMeetings])); }
function loadSelections() {
  try { const s = JSON.parse(localStorage.getItem('provisors-selected') || '[]');
    s.forEach(idx => { if (idx >= 0 && idx < GROUPS.length) selectedMeetings.add(idx); });
    renderMyMeetings();
  } catch(e) {}
}

// ── Calendar Logic ──
function calNav(delta) { calMonth += delta; if (calMonth > 11) { calMonth = 0; calYear++; } if (calMonth < 0) { calMonth = 11; calYear--; } renderCalendar(); }
function calToday() { const n = new Date(); calYear = n.getFullYear(); calMonth = n.getMonth(); renderCalendar(); }

function renderCalendar() {
  const grid = document.getElementById('cal-grid');
  if (!grid) return;
  document.getElementById('cal-month-title').textContent = `${MONTH_NAMES[calMonth]} ${calYear}`;

  const firstDay = new Date(calYear, calMonth, 1);
  const lastDay = new Date(calYear, calMonth + 1, 0);
  const startPad = firstDay.getDay(); // 0=Sun
  const daysInMonth = lastDay.getDate();
  const today = new Date(); today.setHours(0,0,0,0);

  // Build meeting data for this month: map dateStr → { booked: [...], available: [...] }
  const meetingsByDate = {};
  GROUPS.forEach((g, idx) => {
    const parsed = parseDayPattern(g.day);
    if (!parsed) return;
    const date = getNthWeekday(calYear, calMonth, parsed.nth, parsed.weekdayIndex);
    if (!date) return;
    const key = date.toDateString();
    if (!meetingsByDate[key]) meetingsByDate[key] = { booked: [], available: [] };
    const slot = getTimeSlot(g.time);
    if (selectedMeetings.has(idx)) {
      meetingsByDate[key].booked.push({ idx, slot, group: g });
    } else {
      meetingsByDate[key].available.push({ idx, slot, group: g });
    }
  });

  let html = '';
  // Previous month padding
  const prevMonthDays = new Date(calYear, calMonth, 0).getDate();
  for (let i = startPad - 1; i >= 0; i--) {
    html += `<div class="cal-day outside"><div class="cal-day-num">${prevMonthDays - i}</div></div>`;
  }

  // Days of the month
  for (let d = 1; d <= daysInMonth; d++) {
    const date = new Date(calYear, calMonth, d);
    const isToday = date.getTime() === today.getTime();
    const isWeekend = date.getDay() === 0 || date.getDay() === 6;
    const key = date.toDateString();
    const meetings = meetingsByDate[key];
    let classes = 'cal-day';
    if (isToday) classes += ' today';
    if (isWeekend) classes += ' weekend';

    html += `<div class="${classes}"><div class="cal-day-num">${d}</div><div class="cal-slots">`;

    if (isWeekend) {
      html += '</div></div>';
      continue;
    }

    // Three sections: morning, midday, evening
    ['morning', 'lunch', 'evening'].forEach(slot => {
      const slotLabel = slot === 'morning' ? 'AM' : slot === 'lunch' ? 'PM' : 'EVE';
      const sectionName = slot === 'morning' ? 'Morning' : slot === 'lunch' ? 'Midday' : 'Evening';
      const sectionClass = slot === 'morning' ? 'section-morning' : slot === 'lunch' ? 'section-midday' : 'section-evening';
      const booked = meetings ? meetings.booked.filter(m => m.slot === slot) : [];
      const avail = meetings ? meetings.available.filter(m => m.slot === slot) : [];

      html += `<div class="cal-time-section ${sectionClass}"><div class="cal-time-header">${sectionName}</div>`;

      if (booked.length > 0) {
        booked.forEach(m => {
          const cls = m.idx === myHomeGroupIdx ? 'booked-home-group' : m.group.type === 'Affinity' ? 'booked-affinity' : 'booked';
          html += `<div class="cal-slot ${cls}" onmouseenter="showTooltip(event,${m.idx},true)" onmouseleave="hideTooltip()">
            <span class="slot-label">${slotLabel}</span><span class="slot-name">${m.group.name}</span></div>`;
        });
        if (avail.length > 0) {
          html += `<div class="cal-slot available" onclick="filterForSlot('${date.toISOString()}','${slot}')"
            onmouseenter="showSlotTooltip(event,'${key}','${slot}',false)" onmouseleave="hideTooltip()">
            <span class="slot-label">+</span><span class="slot-name">${avail.length} more</span>
            <span class="slot-count">${avail.length}</span></div>`;
        }
      } else if (avail.length > 0) {
        html += `<div class="cal-slot available" onclick="filterForSlot('${date.toISOString()}','${slot}')"
          onmouseenter="showSlotTooltip(event,'${key}','${slot}',false)" onmouseleave="hideTooltip()">
          <span class="slot-label">${slotLabel}</span><span class="slot-name">${avail.length} available</span>
          <span class="slot-count">${avail.length}</span></div>`;
      } else {
        html += `<div class="cal-slot open"><span class="slot-label">${slotLabel}</span><span class="slot-name">open</span></div>`;
      }

      html += '</div>'; // close cal-time-section
    });
    html += '</div></div>';
  }

  // Next month padding
  const totalCells = startPad + daysInMonth;
  const remaining = (7 - (totalCells % 7)) % 7;
  for (let i = 1; i <= remaining; i++) {
    html += `<div class="cal-day outside"><div class="cal-day-num">${i}</div></div>`;
  }

  grid.innerHTML = html;
}

// ── Tooltip ──
const tooltip = document.getElementById('slot-tooltip');
function showTooltip(e, idx, isBooked) {
  if (idx < 0) return;
  const g = GROUPS[idx];
  const dist = g.distance !== null ? `<br>${g.distance.toFixed(1)} mi away` : '';
  const fmtTag = g.format === 'Virtual' ? '<span style="color:#0077b6;font-weight:600;"> &#128187; Virtual</span>'
    : g.format === 'In-Person' ? '<span style="color:#1a7f37;font-weight:600;"> &#128205; In-Person</span>' : '';
  tooltip.innerHTML = `<h4>${g.name}${fmtTag}</h4>${g.type} Group &bull; ${g.region}<br>
    Leader: ${g.leader}<br>${g.day} &bull; ${g.time}<br>${g.city}${dist}`;
  positionTooltip(e);
  tooltip.classList.add('show');
}
function showSlotTooltip(e, dateKey, slot, isBooked) {
  const meetings = {};
  GROUPS.forEach((g, idx) => {
    const parsed = parseDayPattern(g.day);
    if (!parsed) return;
    const date = getNthWeekday(calYear, calMonth, parsed.nth, parsed.weekdayIndex);
    if (!date || date.toDateString() !== dateKey) return;
    if (getTimeSlot(g.time) !== slot) return;
    if (selectedMeetings.has(idx)) return;
    if (!meetings[idx]) meetings[idx] = g;
  });
  const groups = Object.values(meetings);
  if (!groups.length) return;
  const slotName = slot === 'morning' ? 'Morning (7-9 AM)' : slot === 'lunch' ? 'Lunch (11 AM-2 PM)' : 'Evening (6-9 PM)';
  tooltip.innerHTML = `<h4>${slotName}</h4><div class="tt-groups">${groups.map(g =>
    `<div class="tt-group"><span>${g.name}</span><span class="tt-city">${g.city}</span></div>`
  ).join('')}</div><div style="margin-top:6px;font-size:11px;color:#C5A355;font-weight:600;">Click to filter in table</div>`;
  positionTooltip(e);
  tooltip.classList.add('show');
}
function positionTooltip(e) {
  let x = e.clientX + 12, y = e.clientY + 12;
  if (x + 280 > window.innerWidth) x = e.clientX - 290;
  if (y + 200 > window.innerHeight) y = e.clientY - 200;
  tooltip.style.left = x + 'px'; tooltip.style.top = y + 'px';
}
function hideTooltip() { tooltip.classList.remove('show'); }

// Click an available calendar slot → filter sidebar to exactly those groups
let slotFilterIndices = null; // when set, applyFilters uses this as an override

function filterForSlot(isoDate, slot) {
  const date = new Date(isoDate);
  // Find the exact group indices that meet on this date + slot
  const matchIndices = [];
  GROUPS.forEach((g, idx) => {
    if (selectedMeetings.has(idx)) return; // skip already booked
    const parsed = parseDayPattern(g.day);
    if (!parsed) return;
    const meetDate = getNthWeekday(date.getFullYear(), date.getMonth(), parsed.nth, parsed.weekdayIndex);
    if (!meetDate || meetDate.toDateString() !== date.toDateString()) return;
    if (getTimeSlot(g.time) !== slot) return;
    matchIndices.push(idx);
  });

  if (matchIndices.length === 0) return;

  // Set the override filter and clear UI filters
  slotFilterIndices = new Set(matchIndices);
  document.getElementById('search').value = '';
  document.getElementById('filter-region').value = '';
  document.getElementById('filter-type').value = '';
  document.getElementById('filter-day').value = '';
  document.getElementById('filter-format').value = '';

  // Build a label for the footer
  const slotName = slot === 'morning' ? 'Morning' : slot === 'lunch' ? 'Lunch' : 'Evening';
  const dateLabel = date.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
  slotFilterLabel = `${slotName} groups on ${dateLabel}`;

  applyFilters();
  // Scroll sidebar table to top
  document.querySelector('.table-wrap').scrollTop = 0;
}

// Clear slot filter when user changes any filter control
function clearSlotFilter() {
  if (slotFilterIndices) {
    slotFilterIndices = null;
    slotFilterLabel = null;
  }
}
['search','filter-region','filter-type','filter-day','filter-format','sort-by'].forEach(id => {
  const el = document.getElementById(id);
  if (el) el.addEventListener(el.tagName === 'INPUT' ? 'input' : 'change', clearSlotFilter);
});
let slotFilterLabel = null;

// Enter key on address
document.getElementById('user-address').addEventListener('keydown', e => { if (e.key === 'Enter') geocodeAddress(); });

// ── Hub Integration ──
let SERVER_URL = localStorage.getItem('provisors-server-url') || 'http://localhost:3002';
let hubConnected = false;
let hubSyncData = null;
let hubRegistrations = []; // parsed: { name, date, startTime, endTime, type, location, eventId, viewUrl, calendarUrl }
let autoBookEnabled = localStorage.getItem('provisors-auto-book') === 'true';

// Hub state UI
function updateHubUI(state, message) {
  const dot = document.getElementById('hub-dot');
  const text = document.getElementById('hub-status-text');
  const syncBtn = document.getElementById('hub-sync-btn');
  const loginBtn = document.getElementById('hub-login-btn');
  dot.className = 'hub-dot ' + state;
  text.textContent = message;
  syncBtn.disabled = state !== 'connected';
  loginBtn.textContent = state === 'connected' ? 'Reconnect' : 'Connect to Hub';
}

// Server config
function showServerConfig() {
  document.getElementById('server-url').value = SERVER_URL;
  document.getElementById('server-config').classList.add('show');
  document.getElementById('cfg-overlay').classList.add('show');
}
function hideServerConfig() {
  document.getElementById('server-config').classList.remove('show');
  document.getElementById('cfg-overlay').classList.remove('show');
}
function saveServerConfig() {
  SERVER_URL = document.getElementById('server-url').value.trim().replace(/\/$/, '');
  localStorage.setItem('provisors-server-url', SERVER_URL);
  hideServerConfig();
}

// Auto-book toggle
function toggleAutoBook() {
  autoBookEnabled = document.getElementById('auto-book-toggle').checked;
  localStorage.setItem('provisors-auto-book', autoBookEnabled);
}

// Parse Hub registration card text into structured data
function parseHubRegistration(card) {
  const text = card.text || '';
  const lines = text.split('\n').map(l => l.trim()).filter(l => l);
  if (lines.length < 3) return null;

  // Line 0: "SoCal Cannabis Affinity Group, Virtual - February 2026"
  const nameLine = lines[0];
  const nameMatch = nameLine.match(/^(.+?),\s*(Virtual|In-Person)\s*-\s*(.+)$/);
  if (!nameMatch) return null;

  const eventName = nameMatch[1].trim();
  const location = nameMatch[2];
  const monthYear = nameMatch[3];

  // Line 1: "Tuesday, February 24, 2026, 11:30 AM" (start)
  // Line 2: "Tuesday, February 24, 2026, 01:30 PM" (end)
  const startDate = lines[1];
  const endDate = lines[2];

  // Line 3: "Pacific" (timezone)
  // Line 4: "Affinity Group Meeting" or "Home Group Meeting"
  const eventType = lines.find(l => l.includes('Group Meeting')) || '';
  const isHome = eventType.includes('Home');

  // Extract links
  const links = card.links || [];
  const viewLink = links.find(l => l.text === 'View');
  const calLink = links.find(l => l.text === 'Add to Calendar');
  const cancelLink = links.find(l => l.text === 'Cancel');

  // Parse actual date
  const dateMatch = startDate.match(/\w+,\s+(\w+)\s+(\d+),\s+(\d{4}),?\s+(\d+:\d+\s+\w+)/);
  let parsedDate = null;
  if (dateMatch) {
    parsedDate = new Date(`${dateMatch[1]} ${dateMatch[2]}, ${dateMatch[3]} ${dateMatch[4]}`);
  }

  return {
    eventName,
    location,
    monthYear,
    startDate,
    endDate,
    eventType: isHome ? 'Home' : 'Affinity',
    parsedDate,
    viewUrl: viewLink ? viewLink.href : null,
    calendarUrl: calLink ? calLink.href : null,
    cancelUrl: cancelLink ? cancelLink.href : null,
  };
}

// Parse Hub upcoming event card text
function parseHubEvent(card) {
  const text = card.text || '';
  const lines = text.split('\n').map(l => l.trim()).filter(l => l);
  if (lines.length < 2) return null;

  const nameLine = lines[0];
  // Some events: "Event Name, Virtual - March 2026", others: "Event Name- April 2026"
  const nameMatch = nameLine.match(/^(.+?)(?:,\s*(Virtual|In-Person))?\s*-\s*(.+)$/);
  if (!nameMatch) return null;

  const eventName = nameMatch[1].trim();
  const location = nameMatch[2] || 'TBD';
  const monthYear = nameMatch[3];

  const links = card.links || [];
  const viewLink = links.find(l => l.text === 'View');

  const dateMatch = (lines[1] || '').match(/\w+,\s+(\w+)\s+(\d+)(?:,\s+(\d{4}))?/);
  let parsedDate = null;
  if (dateMatch) {
    const year = dateMatch[3] || new Date().getFullYear();
    parsedDate = new Date(`${dateMatch[1]} ${dateMatch[2]}, ${year}`);
  }

  return {
    eventName,
    location,
    monthYear,
    startDate: lines[1] || '',
    endDate: lines[2] || '',
    parsedDate,
    viewUrl: viewLink ? viewLink.href : null,
  };
}

// Fuzzy match a Hub event name to a GROUPS entry
function matchHubToGroup(hubName) {
  const clean = hubName.toLowerCase()
    .replace(/\s*(affinity|home)\s*group/gi, '')
    .replace(/\s*-\s*greater\s*los\s*angeles/gi, '')
    .replace(/[,\-]/g, ' ')
    .replace(/\s+/g, ' ')
    .trim();

  let bestIdx = -1, bestScore = 0;
  GROUPS.forEach((g, idx) => {
    const gClean = g.name.toLowerCase().replace(/[,\-]/g, ' ').replace(/\s+/g, ' ').trim();
    // Direct include check
    if (clean.includes(gClean) || gClean.includes(clean)) {
      const score = Math.min(clean.length, gClean.length) / Math.max(clean.length, gClean.length);
      if (score > bestScore) { bestScore = score; bestIdx = idx; }
    }
    // Word overlap
    const hubWords = clean.split(' ');
    const gWords = gClean.split(' ');
    const overlap = hubWords.filter(w => gWords.some(gw => gw.includes(w) || w.includes(gw))).length;
    const score = overlap / Math.max(hubWords.length, gWords.length);
    if (score > bestScore) { bestScore = score; bestIdx = idx; }
  });
  return bestScore > 0.4 ? bestIdx : -1;
}

// Hub Login
async function hubLogin() {
  updateHubUI('syncing', 'Hub: Connecting...');
  try {
    const res = await fetch(`${SERVER_URL}/api/hub/login`, { method: 'POST' });
    const data = await res.json();
    if (data.success) {
      hubConnected = true;
      updateHubUI('connected', 'Hub: Connected');
    } else {
      updateHubUI('error', 'Hub: Login failed');
    }
  } catch (e) {
    updateHubUI('error', `Hub: Server unreachable`);
    console.error('Hub login error:', e);
  }
}

// Hub Full Sync
async function hubSync() {
  updateHubUI('syncing', 'Hub: Syncing...');
  document.getElementById('hub-sync-btn').disabled = true;
  document.getElementById('hub-info').textContent = 'Scraping registrations and events...';
  try {
    const res = await fetch(`${SERVER_URL}/api/hub/sync`);
    hubSyncData = await res.json();
    hubConnected = true;

    // Parse registrations
    hubRegistrations = [];
    const regCards = hubSyncData.registrations?.cards || [];
    regCards.forEach(card => {
      const parsed = parseHubRegistration(card);
      if (parsed) hubRegistrations.push(parsed);
    });

    // Deduplicate by eventName + startDate
    const seen = new Set();
    hubRegistrations = hubRegistrations.filter(r => {
      const key = r.eventName + '|' + r.startDate;
      if (seen.has(key)) return false;
      seen.add(key);
      return true;
    });

    // Auto-select matched groups and overlay format data
    let matched = 0;
    hubRegistrations.forEach(reg => {
      const idx = matchHubToGroup(reg.eventName);
      if (idx >= 0) {
        reg.matchedGroupIdx = idx;
        // Overlay format (Virtual/In-Person) from Hub data
        if (reg.location === 'Virtual' || reg.location === 'In-Person') {
          GROUPS[idx].format = reg.location;
        }
        if (!selectedMeetings.has(idx)) {
          selectedMeetings.add(idx);
          matched++;
        }
      }
    });

    // Also overlay format from upcoming events
    const upcomingCards = hubSyncData.upcoming_events?.events || [];
    upcomingCards.forEach(card => {
      const parsed = parseHubEvent(card);
      if (!parsed) return;
      const idx = matchHubToGroup(parsed.eventName);
      if (idx >= 0 && (parsed.location === 'Virtual' || parsed.location === 'In-Person')) {
        GROUPS[idx].format = parsed.location;
      }
    });

    // Save format data to localStorage for offline use
    const formatMap = {};
    GROUPS.forEach((g, i) => { if (g.format) formatMap[i] = g.format; });
    localStorage.setItem('provisors-formats', JSON.stringify(formatMap));

    const ts = hubSyncData.timestamp ? new Date(hubSyncData.timestamp).toLocaleTimeString() : 'now';
    updateHubUI('connected', `Hub: Synced at ${ts}`);
    document.getElementById('hub-info').textContent =
      `${hubRegistrations.length} registrations found, ${matched} new matches added`;

    // Save and re-render
    saveSelections();
    localStorage.setItem('provisors-hub-data', JSON.stringify({
      registrations: hubRegistrations,
      timestamp: hubSyncData.timestamp,
    }));
    applyFilters();

  } catch (e) {
    updateHubUI('error', 'Hub: Sync failed');
    document.getElementById('hub-info').textContent = e.message;
    console.error('Hub sync error:', e);
  }
  document.getElementById('hub-sync-btn').disabled = !hubConnected;
}

// Register for event via Hub bot
async function hubRegister(eventUrl) {
  if (!hubConnected) { alert('Connect to Hub first'); return; }
  try {
    const res = await fetch(`${SERVER_URL}/api/hub/register`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ event_url: eventUrl }),
    });
    const result = await res.json();
    if (result.success) {
      alert('Registration confirmed!');
      hubSync(); // re-sync to update
    } else {
      alert('Registration may not have completed. Check the Hub.\n\n' + (result.page_text || '').substring(0, 200));
    }
  } catch (e) {
    alert('Error registering: ' + e.message);
  }
}

// Check if a group is Hub-registered (optionally for a specific date)
function isHubRegistered(groupIdx, date) {
  return hubRegistrations.some(r => {
    if (r.matchedGroupIdx !== groupIdx) return false;
    if (!date) return true; // no date filter = any match
    if (!r.parsedDate) return false;
    return r.parsedDate.getFullYear() === date.getFullYear()
        && r.parsedDate.getMonth() === date.getMonth();
  });
}

// Check if a date+slot has a Hub registration
function getHubRegForDate(dateStr, slot) {
  return hubRegistrations.filter(r => {
    if (!r.parsedDate) return false;
    return r.parsedDate.toDateString() === dateStr;
  });
}

// Load cached hub data on startup
function loadHubData() {
  try {
    // Load cached format data (Virtual/In-Person) from previous Hub syncs
    const fmtMap = JSON.parse(localStorage.getItem('provisors-formats') || '{}');
    Object.entries(fmtMap).forEach(([idx, fmt]) => {
      if (GROUPS[idx]) GROUPS[idx].format = fmt;
    });

    const cached = JSON.parse(localStorage.getItem('provisors-hub-data') || 'null');
    if (cached && cached.registrations) {
      hubRegistrations = cached.registrations;
      // Re-match groups
      hubRegistrations.forEach(reg => {
        reg.matchedGroupIdx = matchHubToGroup(reg.eventName);
        if (reg.matchedGroupIdx >= 0) {
          if (!selectedMeetings.has(reg.matchedGroupIdx)) {
            selectedMeetings.add(reg.matchedGroupIdx);
          }
          // Also restore format from registration data
          if (reg.location === 'Virtual' || reg.location === 'In-Person') {
            GROUPS[reg.matchedGroupIdx].format = reg.location;
          }
        }
      });
      const ts = cached.timestamp ? new Date(cached.timestamp).toLocaleTimeString() : '';
      if (hubRegistrations.length > 0) {
        document.getElementById('hub-info').textContent =
          `Cached: ${hubRegistrations.length} registrations (synced ${ts})`;
      }
    }
  } catch(e) {}
  document.getElementById('auto-book-toggle').checked = autoBookEnabled;
}

// ── Override renderTable to show Hub badges ──
const _origRenderTable = renderTable;
renderTable = function() {
  const tbody = document.getElementById('table-body');
  tbody.innerHTML = filtered.map(g => {
    const idx = GROUPS.indexOf(g);
    const checked = selectedMeetings.has(idx) ? 'checked' : '';
    const hubReg = isHubRegistered(idx);
    const hubBadge = hubReg ? '<span class="hub-reg-badge">HUB</span>' : '';
    const isMyHome = idx === myHomeGroupIdx;
    const homeBadge = isMyHome ? ' <span style="color:#1a7f37;font-size:10px;font-weight:700;">&#9733; MY HOME</span>' : '';
    const homeBtn = g.type === 'Home' && !isMyHome
      ? `<span onclick="event.stopPropagation();setMyHomeGroup(${idx})" title="Set as my home group" style="cursor:pointer;color:#aaa;font-size:10px;margin-left:4px;">&#9734;</span>` : '';
    const rowClass = `${selectedMeetings.has(idx)?'selected':''} ${hubReg?'hub-registered':''} ${isMyHome?'my-home-group':''}`;
    const fmtBadge = g.format === 'Virtual' ? '<span class="badge virtual">Virtual</span>'
      : g.format === 'In-Person' ? '<span class="badge in-person">In-Person</span>'
      : g.format === 'In-Person & Virtual' ? '<span class="badge hybrid">Hybrid</span>'
      : '<span style="color:#aaa;font-size:10px">—</span>';
    return `<tr onclick="focusGroup(${idx})" data-idx="${idx}" class="${rowClass}">
      <td class="cb-col" onclick="event.stopPropagation()"><input type="checkbox" ${checked} onchange="toggleSelection(${idx},this.checked)" /></td>
      <td><strong>${g.name}</strong>${hubBadge}${homeBadge}${homeBtn}<br><span style="color:#636e72;font-size:11px">${g.leader}</span></td>
      <td><span class="badge ${g.type.toLowerCase()}">${g.type}</span></td>
      <td>${g.city}</td>
      <td style="white-space:nowrap">${g.day}</td>
      <td style="white-space:nowrap">${g.time}</td>
      <td>${fmtBadge}</td>
      <td class="distance-cell">${g.distance!==null?g.distance.toFixed(1)+' mi':'—'}</td></tr>`;
  }).join('');
  const footerText = slotFilterLabel
    ? `Showing ${filtered.length} groups — ${slotFilterLabel}`
    : `Showing ${filtered.length} of ${GROUPS.length} groups`;
  document.getElementById('table-footer').textContent = footerText;
};

// ── Override renderCalendar to show Hub registrations ──
const _origRenderCalendar = renderCalendar;
renderCalendar = function() {
  const grid = document.getElementById('cal-grid');
  if (!grid) return;
  document.getElementById('cal-month-title').textContent = `${MONTH_NAMES[calMonth]} ${calYear}`;

  const firstDay = new Date(calYear, calMonth, 1);
  const lastDay = new Date(calYear, calMonth + 1, 0);
  const startPad = firstDay.getDay();
  const daysInMonth = lastDay.getDate();
  const today = new Date(); today.setHours(0,0,0,0);

  const meetingsByDate = {};
  GROUPS.forEach((g, idx) => {
    const parsed = parseDayPattern(g.day);
    if (!parsed) return;
    const date = getNthWeekday(calYear, calMonth, parsed.nth, parsed.weekdayIndex);
    if (!date) return;
    const key = date.toDateString();
    if (!meetingsByDate[key]) meetingsByDate[key] = { booked: [], available: [], hubBooked: [] };
    const slot = getTimeSlot(g.time);
    const hubReg = isHubRegistered(idx, date);
    if (hubReg) {
      meetingsByDate[key].hubBooked.push({ idx, slot, group: g });
    } else if (selectedMeetings.has(idx)) {
      meetingsByDate[key].booked.push({ idx, slot, group: g });
    } else {
      meetingsByDate[key].available.push({ idx, slot, group: g });
    }
  });

  // Also add unmatched Hub registrations
  hubRegistrations.forEach(reg => {
    if (reg.matchedGroupIdx >= 0) return; // already shown via groups
    if (!reg.parsedDate) return;
    if (reg.parsedDate.getMonth() !== calMonth || reg.parsedDate.getFullYear() !== calYear) return;
    const key = reg.parsedDate.toDateString();
    if (!meetingsByDate[key]) meetingsByDate[key] = { booked: [], available: [], hubBooked: [] };
    const slot = reg.startDate.includes('AM') && !reg.startDate.includes('11') && !reg.startDate.includes('12') ? 'morning' : 'lunch';
    meetingsByDate[key].hubBooked.push({
      idx: -1, slot, group: { name: reg.eventName, type: reg.eventType, region: '', leader: '', day: '', time: reg.startDate, city: reg.location }
    });
  });

  let html = '';
  const prevMonthDays = new Date(calYear, calMonth, 0).getDate();
  for (let i = startPad - 1; i >= 0; i--) {
    html += `<div class="cal-day outside"><div class="cal-day-num">${prevMonthDays - i}</div></div>`;
  }

  for (let d = 1; d <= daysInMonth; d++) {
    const date = new Date(calYear, calMonth, d);
    const isToday = date.getTime() === today.getTime();
    const isWeekend = date.getDay() === 0 || date.getDay() === 6;
    const key = date.toDateString();
    const meetings = meetingsByDate[key];
    let classes = 'cal-day';
    if (isToday) classes += ' today';
    if (isWeekend) classes += ' weekend';

    html += `<div class="${classes}"><div class="cal-day-num">${d}</div><div class="cal-slots">`;

    if (isWeekend) { html += '</div></div>'; continue; }

    ['morning', 'lunch', 'evening'].forEach(slot => {
      const slotLabel = slot === 'morning' ? 'AM' : slot === 'lunch' ? 'PM' : 'EVE';
      const sectionName = slot === 'morning' ? 'Morning' : slot === 'lunch' ? 'Midday' : 'Evening';
      const sectionClass = slot === 'morning' ? 'section-morning' : slot === 'lunch' ? 'section-midday' : 'section-evening';
      const hubBooked = meetings ? meetings.hubBooked.filter(m => m.slot === slot) : [];
      const booked = meetings ? meetings.booked.filter(m => m.slot === slot) : [];
      const avail = meetings ? meetings.available.filter(m => m.slot === slot) : [];

      html += `<div class="cal-time-section ${sectionClass}"><div class="cal-time-header">${sectionName}</div>`;

      // Hub-registered meetings (green)
      hubBooked.forEach(m => {
        html += `<div class="cal-slot hub-booked" onmouseenter="showTooltip(event,${m.idx >= 0 ? m.idx : -1},true)" onmouseleave="hideTooltip()">
          <span class="slot-label">${slotLabel}</span><span class="slot-name">${m.group.name}</span></div>`;
      });

      // User-selected booked meetings
      if (booked.length > 0) {
        booked.forEach(m => {
          const cls = m.idx === myHomeGroupIdx ? 'booked-home-group' : m.group.type === 'Affinity' ? 'booked-affinity' : 'booked';
          html += `<div class="cal-slot ${cls}" onmouseenter="showTooltip(event,${m.idx},true)" onmouseleave="hideTooltip()">
            <span class="slot-label">${slotLabel}</span><span class="slot-name">${m.group.name}</span></div>`;
        });
      }

      // Available
      if (avail.length > 0) {
        const label = (hubBooked.length > 0 || booked.length > 0) ? '+' : slotLabel;
        html += `<div class="cal-slot available" onclick="filterForSlot('${date.toISOString()}','${slot}')"
          onmouseenter="showSlotTooltip(event,'${key}','${slot}',false)" onmouseleave="hideTooltip()">
          <span class="slot-label">${label}</span><span class="slot-name">${avail.length} available</span>
          <span class="slot-count">${avail.length}</span></div>`;
      } else if (hubBooked.length === 0 && booked.length === 0) {
        html += `<div class="cal-slot open"><span class="slot-label">${slotLabel}</span><span class="slot-name">open</span></div>`;
      }

      html += '</div>'; // close cal-time-section
    });
    html += '</div></div>';
  }

  const totalCells = startPad + daysInMonth;
  const remaining = (7 - (totalCells % 7)) % 7;
  for (let i = 1; i <= remaining; i++) {
    html += `<div class="cal-day outside"><div class="cal-day-num">${i}</div></div>`;
  }
  grid.innerHTML = html;
};

// ── Override renderMyMeetings to show Hub badges ──
const _origRenderMyMeetings = renderMyMeetings;
renderMyMeetings = function() {
  const body = document.getElementById('my-meetings-body');
  const count = document.getElementById('my-meetings-count');
  const panel = document.getElementById('my-meetings-panel');
  count.textContent = selectedMeetings.size;
  document.getElementById('stat-selected').textContent = selectedMeetings.size;
  if (selectedMeetings.size === 0) { body.innerHTML = '<div class="my-meetings-empty">Check meetings above to add them to your list</div>'; return; }
  if (selectedMeetings.size === 1 && panel.classList.contains('collapsed')) { panel.classList.remove('collapsed'); panel.classList.add('expanded'); }
  const sorted = [...selectedMeetings].sort((a, b) => daySort(GROUPS[a].day) - daySort(GROUPS[b].day));
  body.innerHTML = sorted.map(idx => {
    const g = GROUPS[idx]; const dist = g.distance !== null ? ` &bull; ${g.distance.toFixed(1)} mi` : '';
    const hubReg = isHubRegistered(idx);
    const hubBadge = hubReg ? ' <span class="hub-reg-badge">HUB</span>' : '';
    const isMyHome = idx === myHomeGroupIdx;
    const homeBadge = isMyHome ? ' <span style="color:#1a7f37;font-size:10px;font-weight:700;">&#9733; MY HOME</span>' : '';
    const typeLabel = isMyHome ? '' : g.type === 'Affinity' ? ' <span style="color:#C5A355;font-size:10px;font-weight:600;">Affinity</span>' : ' <span style="color:#153D63;font-size:10px;font-weight:600;">Visiting</span>';
    const bookBtn = (!hubReg && autoBookEnabled && hubConnected)
      ? `<button onclick="event.stopPropagation(); bookMeeting(${idx})" style="background:#27ae60;color:white;border:none;border-radius:3px;padding:2px 6px;font-size:10px;font-weight:600;cursor:pointer;margin-right:4px;">Book</button>`
      : '';
    const fmtLabel = g.format === 'Virtual' ? ' <span style="color:#0077b6;font-size:10px;font-weight:600;">&#128187; Virtual</span>'
      : g.format === 'In-Person' ? ' <span style="color:#1a7f37;font-size:10px;font-weight:600;">&#128205; In-Person</span>' : '';
    return `<div class="my-meeting-item" style="${isMyHome?'border-left:3px solid #1a7f37;':''}"><div class="my-meeting-info"><strong>${g.name}</strong>${hubBadge}${homeBadge}${typeLabel}${fmtLabel}
      <div class="meta">${g.day} &bull; ${g.time} &bull; ${g.city}${dist}</div></div>
      ${bookBtn}<button class="my-meeting-remove" onclick="removeSelection(${idx})" title="Remove">&times;</button></div>`;
  }).join('');
};

// Book a meeting via Hub
async function bookMeeting(idx) {
  if (!hubConnected) { alert('Connect to Hub first'); return; }
  const g = GROUPS[idx];
  // Try to find matching event in upcoming events
  const upcomingEvents = hubSyncData?.upcoming_events?.events || [];
  let matchedEvent = null;
  for (const evt of upcomingEvents) {
    const parsed = parseHubEvent(evt);
    if (!parsed) continue;
    const matchIdx = matchHubToGroup(parsed.eventName);
    if (matchIdx === idx) { matchedEvent = parsed; break; }
  }
  if (matchedEvent && matchedEvent.viewUrl) {
    if (confirm(`Book "${g.name}" via the ProVisors Hub?\n\nThis will open the registration page and attempt to register you.`)) {
      await hubRegister(matchedEvent.viewUrl);
    }
  } else {
    // Fallback: open Hub event search
    if (confirm(`Could not find "${g.name}" in upcoming events.\n\nOpen the Hub event search instead?`)) {
      window.open('https://hub.provisors.com/event-search', '_blank');
    }
  }
}

// ── Override openHub to be smarter ──
openHub = function() {
  if (hubConnected) {
    window.open('https://hub.provisors.com/nc__myregistrations', '_blank');
  } else {
    window.open('https://hub.provisors.com/personalsnapshot', '_blank');
  }
};

// ── Init ──
initHubRegistrations(); // load embedded Hub data first (sets formats + selections)
loadSelections();       // then overlay any user localStorage selections
loadHubData();          // then load any cached live-sync data (overrides embedded)
applyFilters();
</script>
</body>
</html>
